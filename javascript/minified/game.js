var Kinetic={Filters:{},Plugins:{},Global:{BUFFER_WHITELIST:["fill","stroke","textFill","textStroke"],BUFFER_BLACKLIST:["shadow"],stages:[],idCounter:0,tempNodes:{},shapes:{},warn:function(a){window.console&&console.warn&&console.warn("Kinetic warning: "+a)},extend:function(a,b){for(var d in b.prototype)d in a.prototype||(a.prototype[d]=b.prototype[d])},_pullNodes:function(a){var b=this.tempNodes,d;for(d in b){var c=b[d];void 0!==c.getStage()&&c.getStage()._id===a._id&&(a._addId(c),a._addName(c),this._removeTempNode(c))}},_addTempNode:function(a){this.tempNodes[a._id]=a},_removeTempNode:function(a){delete this.tempNodes[a._id]}},Type:{_isElement:function(a){return!!(a&&1==a.nodeType)},_isFunction:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},_isObject:function(a){return!!a&&a.constructor==Object},_isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a)},_isNumber:function(a){return"[object Number]"==Object.prototype.toString.call(a)},_isString:function(a){return"[object String]"==Object.prototype.toString.call(a)},_hasMethods:function(a){var b=[],d;for(d in a)this._isFunction(a[d])&&b.push(d);return 0<b.length},_getXY:function(a){if(this._isNumber(a))return{x:a,y:a};if(this._isArray(a))if(1===a.length){a=a[0];if(this._isNumber(a))return{x:a,y:a};if(this._isArray(a))return{x:a[0],y:a[1]};if(this._isObject(a))return a}else{if(2<=a.length)return{x:a[0],y:a[1]}}else if(this._isObject(a))return a;return{x:0,y:0}},_getSize:function(a){if(this._isNumber(a))return{width:a,height:a};if(this._isArray(a))if(1===a.length){a=a[0];if(this._isNumber(a))return{width:a,height:a};if(this._isArray(a)){if(4<=a.length)return{width:a[2],height:a[3]};if(2<=a.length)return{width:a[0],height:a[1]}}else if(this._isObject(a))return a}else{if(4<=a.length)return{width:a[2],height:a[3]};if(2<=a.length)return{width:a[0],height:a[1]}}else if(this._isObject(a))return a;return{width:0,height:0}},_getPoints:function(a){if(void 0===a)return[];if(this._isObject(a[0]))return a;for(var b=[],d=0;d<a.length;d+=2)b.push({x:a[d],y:a[d+1]});return b},_getImage:function(a,b){if(a)if(this._isElement(a))b(a);else if(this._isString(a)){var d=new Image;d.onload=function(){b(d)};d.src=a}else if(a.data){var c=document.createElement("canvas");c.width=a.width;c.height=a.height;c.getContext("2d").putImageData(a,0,0);c=c.toDataURL();d=new Image;d.onload=function(){b(d)};d.src=c}else b(null);else b(null)},_rgbToHex:function(a,b,d){return(16777216+(a<<16)+(b<<8)+d).toString(16).slice(1)},_hexToRgb:function(a){a=parseInt(a,16);return{r:a>>16&255,g:a>>8&255,b:a&255}},_getRandomColorKey:function(){var a=Math.round(255*Math.random()),b=Math.round(255*Math.random()),d=Math.round(255*Math.random());return this._rgbToHex(a,b,d)},_merge:function(a,b){var d=this._clone(b),c;for(c in a)d[c]=this._isObject(a[c])?this._merge(a[c],d[c]):a[c];return d},_clone:function(a){var b={},d;for(d in a)b[d]=this._isObject(a[d])?this._clone(a[d]):a[d];return b}},Canvas:function(a,b,d){this.element=document.createElement("canvas");this.context=this.element.getContext("2d");this.element.width=a||0;this.element.height=b||0;this.context.renderer=d?new Kinetic.HitRenderer(this.context):new Kinetic.SceneRenderer(this.context)}};Kinetic.Canvas.prototype={clear:function(){var a=this.getContext(),b=this.getElement();a.clearRect(0,0,b.width,b.height)},getElement:function(){return this.element},getContext:function(){return this.context},setWidth:function(a){this.element.width=a},setHeight:function(a){this.element.height=a},getWidth:function(){return this.element.width},getHeight:function(){return this.element.height},setSize:function(a,b){this.setWidth(a);this.setHeight(b)},toDataURL:function(a,b){try{return this.element.toDataURL(a,b)}catch(d){try{return this.element.toDataURL()}catch(c){return Kinetic.Global.warn("Unable to get data URL. "+c.message),""}}}};Kinetic.SceneRenderer=function(a){this.context=a};Kinetic.SceneRenderer.prototype={_fill:function(a,b){var d=this.context,c=a.getFill(),e=a._getFillType(c),f=a.getShadow();if(c){d.save();!b&&f&&this._applyShadow(a);var g=c.start,j=c.end;switch(e){case"COLOR":d.fillStyle=c;d.fill(d);break;case"PATTERN":e=!c.repeat?"repeat":c.repeat;c.scale&&d.scale(c.scale.x,c.scale.y);c.offset&&d.translate(c.offset.x,c.offset.y);d.fillStyle=d.createPattern(c.image,e);d.fill(d);break;case"LINEAR_GRADIENT":e=d.createLinearGradient(g.x,g.y,j.x,j.y);c=c.colorStops;for(g=0;g<c.length;g+=2)e.addColorStop(c[g],c[g+1]);d.fillStyle=e;d.fill(d);break;case"RADIAL_GRADIENT":e=d.createRadialGradient(g.x,g.y,g.radius,j.x,j.y,j.radius);c=c.colorStops;for(g=0;g<c.length;g+=2)e.addColorStop(c[g],c[g+1]);d.fillStyle=e;d.fill(d);break;default:d.fillStyle="black",d.fill(d)}d.restore();!b&&(f&&f.opacity)&&this._fill(a,!0)}},_stroke:function(a,b){var d=this.context,c=a.getStroke(),e=a.getStrokeWidth(),f=a.getShadow();if(c||e)d.save(),!b&&f&&this._applyShadow(a),d.lineWidth=e||2,d.strokeStyle=c||"black",d.stroke(d),d.restore(),!b&&(f&&f.opacity)&&this._stroke(a,!0)},_applyShadow:function(a){var b=this.context,d=a.getShadow();if(d){a=a.getAbsoluteOpacity();var c=d.color||"black",e=d.blur||5,f=d.offset||{x:0,y:0};d.opacity&&(b.globalAlpha=d.opacity*a);b.shadowColor=c;b.shadowBlur=e;b.shadowOffsetX=f.x;b.shadowOffsetY=f.y}}};Kinetic.HitRenderer=function(a){this.context=a};Kinetic.HitRenderer.prototype={_fill:function(a){var b=this.context;b.save();b.fillStyle="#"+a.colorKey;b.fill(b);b.restore()},_stroke:function(a){var b=this.context,d=a.getStroke(),c=a.getStrokeWidth();if(d||c)b.save(),b.lineWidth=c||2,b.strokeStyle="#"+a.colorKey,b.stroke(b),b.restore()}};Kinetic.Tween=function(a,b,d,c,e,f){this._listeners=[];this.addListener(this);this.obj=a;this.propFunc=b;this._pos=this.begin=c;this.setDuration(f);this.isPlaying=!1;this.prevPos=this.prevTime=this._change=0;this.looping=!1;this._finish=this._startTime=this._position=this._time=0;this.name="";this.func=d;this.setFinish(e)};Kinetic.Tween.prototype={setTime:function(a){this.prevTime=this._time;a>this.getDuration()?this.looping?(this.rewind(a-this._duration),this.update(),this.broadcastMessage("onLooped",{target:this,type:"onLooped"})):(this._time=this._duration,this.update(),this.stop(),this.broadcastMessage("onFinished",{target:this,type:"onFinished"})):(0>a?this.rewind():this._time=a,this.update())},getTime:function(){return this._time},setDuration:function(a){this._duration=null===a||0>=a?1E5:a},getDuration:function(){return this._duration},setPosition:function(a){this.prevPos=this._pos;this.propFunc(a);this._pos=a;this.broadcastMessage("onChanged",{target:this,type:"onChanged"})},getPosition:function(a){void 0===a&&(a=this._time);return this.func(a,this.begin,this._change,this._duration)},setFinish:function(a){this._change=a-this.begin},getFinish:function(){return this.begin+this._change},start:function(){this.rewind();this.startEnterFrame();this.broadcastMessage("onStarted",{target:this,type:"onStarted"})},rewind:function(a){this.stop();this._time=void 0===a?0:a;this.fixTime();this.update()},fforward:function(){this._time=this._duration;this.fixTime();this.update()},update:function(){this.setPosition(this.getPosition(this._time))},startEnterFrame:function(){this.stopEnterFrame();this.isPlaying=!0;this.onEnterFrame()},onEnterFrame:function(){this.isPlaying&&this.nextFrame()},nextFrame:function(){this.setTime((this.getTimer()-this._startTime)/1E3)},stop:function(){this.stopEnterFrame();this.broadcastMessage("onStopped",{target:this,type:"onStopped"})},stopEnterFrame:function(){this.isPlaying=!1},continueTo:function(a,b){this.begin=this._pos;this.setFinish(a);void 0!==this._duration&&this.setDuration(b);this.start()},resume:function(){this.fixTime();this.startEnterFrame();this.broadcastMessage("onResumed",{target:this,type:"onResumed"})},yoyo:function(){this.continueTo(this.begin,this._time)},addListener:function(a){this.removeListener(a);return this._listeners.push(a)},removeListener:function(a){for(var b=this._listeners,d=b.length;d--;)if(b[d]==a)return b.splice(d,1),!0;return!1},broadcastMessage:function(){for(var a=[],b=0;b<arguments.length;b++)a.push(arguments[b]);for(var d=a.shift(),c=this._listeners,e=c.length,b=0;b<e;b++)c[b][d]&&c[b][d].apply(c[b],a)},fixTime:function(){this._startTime=this.getTimer()-1E3*this._time},getTimer:function(){return(new Date).getTime()-this._time}};Kinetic.Tweens={"back-ease-in":function(a,b,d,c){return d*(a/=c)*a*(2.70158*a-1.70158)+b},"back-ease-out":function(a,b,d,c){return d*((a=a/c-1)*a*(2.70158*a+1.70158)+1)+b},"back-ease-in-out":function(a,b,d,c){var e=1.70158;return 1>(a/=c/2)?d/2*a*a*(((e*=1.525)+1)*a-e)+b:d/2*((a-=2)*a*(((e*=1.525)+1)*a+e)+2)+b},"elastic-ease-in":function(a,b,d,c,e,f){var g=0;if(0===a)return b;if(1==(a/=c))return b+d;f||(f=0.3*c);!e||e<Math.abs(d)?(e=d,g=f/4):g=f/(2*Math.PI)*Math.asin(d/e);return-(e*Math.pow(2,10*(a-=1))*Math.sin((a*c-g)*2*Math.PI/f))+b},"elastic-ease-out":function(a,b,d,c,e,f){var g=0;if(0===a)return b;if(1==(a/=c))return b+d;f||(f=0.3*c);!e||e<Math.abs(d)?(e=d,g=f/4):g=f/(2*Math.PI)*Math.asin(d/e);return e*Math.pow(2,-10*a)*Math.sin((a*c-g)*2*Math.PI/f)+d+b},"elastic-ease-in-out":function(a,b,d,c,e,f){var g=0;if(0===a)return b;if(2==(a/=c/2))return b+d;f||(f=c*0.3*1.5);!e||e<Math.abs(d)?(e=d,g=f/4):g=f/(2*Math.PI)*Math.asin(d/e);return 1>a?-0.5*e*Math.pow(2,10*(a-=1))*Math.sin((a*c-g)*2*Math.PI/f)+b:0.5*e*Math.pow(2,-10*(a-=1))*Math.sin((a*c-g)*2*Math.PI/f)+d+b},"bounce-ease-out":function(a,b,d,c){return(a/=c)<1/2.75?d*7.5625*a*a+b:a<2/2.75?d*(7.5625*(a-=1.5/2.75)*a+0.75)+b:a<2.5/2.75?d*(7.5625*(a-=2.25/2.75)*a+0.9375)+b:d*(7.5625*(a-=2.625/2.75)*a+0.984375)+b},"bounce-ease-in":function(a,b,d,c){return d-Kinetic.Tweens["bounce-ease-out"](c-a,0,d,c)+b},"bounce-ease-in-out":function(a,b,d,c){return a<c/2?0.5*Kinetic.Tweens["bounce-ease-in"](2*a,0,d,c)+b:0.5*Kinetic.Tweens["bounce-ease-out"](2*a-c,0,d,c)+0.5*d+b},"ease-in":function(a,b,d,c){return d*(a/=c)*a+b},"ease-out":function(a,b,d,c){return-d*(a/=c)*(a-2)+b},"ease-in-out":function(a,b,d,c){return 1>(a/=c/2)?d/2*a*a+b:-d/2*(--a*(a-2)-1)+b},"strong-ease-in":function(a,b,d,c){return d*(a/=c)*a*a*a*a+b},"strong-ease-out":function(a,b,d,c){return d*((a=a/c-1)*a*a*a*a+1)+b},"strong-ease-in-out":function(a,b,d,c){return 1>(a/=c/2)?d/2*a*a*a*a*a+b:d/2*((a-=2)*a*a*a*a+2)+b},linear:function(a,b,d,c){return d*a/c+b}};Kinetic.Transform=function(){this.m=[1,0,0,1,0,0]};Kinetic.Transform.prototype={translate:function(a,b){this.m[4]+=this.m[0]*a+this.m[2]*b;this.m[5]+=this.m[1]*a+this.m[3]*b},scale:function(a,b){this.m[0]*=a;this.m[1]*=a;this.m[2]*=b;this.m[3]*=b},rotate:function(a){var b=Math.cos(a);a=Math.sin(a);var d=this.m[1]*b+this.m[3]*a,c=this.m[0]*-a+this.m[2]*b,e=this.m[1]*-a+this.m[3]*b;this.m[0]=this.m[0]*b+this.m[2]*a;this.m[1]=d;this.m[2]=c;this.m[3]=e},getTranslation:function(){return{x:this.m[4],y:this.m[5]}},multiply:function(a){var b=this.m[1]*a.m[0]+this.m[3]*a.m[1],d=this.m[0]*a.m[2]+this.m[2]*a.m[3],c=this.m[1]*a.m[2]+this.m[3]*a.m[3],e=this.m[0]*a.m[4]+this.m[2]*a.m[5]+this.m[4],f=this.m[1]*a.m[4]+this.m[3]*a.m[5]+this.m[5];this.m[0]=this.m[0]*a.m[0]+this.m[2]*a.m[1];this.m[1]=b;this.m[2]=d;this.m[3]=c;this.m[4]=e;this.m[5]=f},invert:function(){var a=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),b=-this.m[1]*a,d=-this.m[2]*a,c=this.m[0]*a,e=a*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),f=a*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=this.m[3]*a;this.m[1]=b;this.m[2]=d;this.m[3]=c;this.m[4]=e;this.m[5]=f},getMatrix:function(){return this.m}};Kinetic.Collection=function(){var a=[].slice.call(arguments),b=a.length,d=0;for(this.length=b;d<b;d++)this[d]=a[d];return this};Kinetic.Collection.prototype=[];Kinetic.Collection.prototype.apply=function(a){args=[].slice.call(arguments);args.shift();for(var b=0;b<this.length;b++)Kinetic.Type._isFunction(this[b][a])&&this[b][a].apply(this[b],args)};Kinetic.Collection.prototype.each=function(a){for(var b=0;b<this.length;b++)a.call(this[b],b,this[b])};Kinetic.Filters.Grayscale=function(a){a=a.data;for(var b=0;b<a.length;b+=4){var d=0.34*a[b]+0.5*a[b+1]+0.16*a[b+2];a[b]=d;a[b+1]=d;a[b+2]=d}};Kinetic.Filters.Brighten=function(a,b){for(var d=b.val||0,c=a.data,e=0;e<c.length;e+=4)c[e]+=d,c[e+1]+=d,c[e+2]+=d};Kinetic.Filters.Invert=function(a){a=a.data;for(var b=0;b<a.length;b+=4)a[b]=255-a[b],a[b+1]=255-a[b+1],a[b+2]=255-a[b+2]};Kinetic.Animation=function(a,b){this.func=a;this.node=b;this.id=Kinetic.Animation.animIdCounter++};Kinetic.Animation.prototype={start:function(){this.stop();Kinetic.Animation._addAnimation(this);Kinetic.Animation._handleAnimation()},stop:function(){Kinetic.Animation._removeAnimation(this)}};Kinetic.Animation.animations=[];Kinetic.Animation.animIdCounter=0;Kinetic.Animation.animRunning=!1;Kinetic.Animation.frame={time:0,timeDiff:0,lastTime:(new Date).getTime(),frameRate:0};Kinetic.Animation.fixedRequestAnimFrame=function(a){window.setTimeout(a,1E3/60)};Kinetic.Animation._addAnimation=function(a){this.animations.push(a)};Kinetic.Animation._removeAnimation=function(a){a=a.id;for(var b=this.animations,d=0;d<b.length;d++)if(b[d].id===a){this.animations.splice(d,1);break}};Kinetic.Animation._updateFrameObject=function(){var a=(new Date).getTime();this.frame.timeDiff=a-this.frame.lastTime;this.frame.lastTime=a;this.frame.time+=this.frame.timeDiff;this.frame.frameRate=1E3/this.frame.timeDiff};Kinetic.Animation._runFrames=function(){this._updateFrameObject();for(var a={},b=0;b<this.animations.length;b++){var d=this.animations[b];d.node&&void 0!==d.node._id&&(a[d.node._id]=d.node);d.func&&d.func(this.frame)}for(var c in a)a[c].draw()};Kinetic.Animation._animationLoop=function(){if(0<this.animations.length){this._runFrames();var a=this;Kinetic.Animation.requestAnimFrame(function(){a._animationLoop()})}else this.animRunning=!1};Kinetic.Animation._handleAnimation=function(){this.animRunning||(this.animRunning=!0,this._animationLoop())};Kinetic.Animation.requestAnimFrame=function(a){(Kinetic.DD&&Kinetic.DD.moving?this.fixedRequestAnimFrame:window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||Kinetic.Animation.fixedRequestAnimFrame)(a)};(function(){Kinetic.Node=function(a){this._nodeInit(a)};Kinetic.Node.prototype={_nodeInit:function(a){this.defaultNodeAttrs={visible:!0,listening:!0,name:void 0,opacity:1,x:0,y:0,scale:{x:1,y:1},rotation:0,offset:{x:0,y:0},draggable:!1};this.setDefaultAttrs(this.defaultNodeAttrs);this.eventListeners={};this.setAttrs(a);var c=this;this.on("idChange.kinetic",function(a){var b=c.getStage();b&&(b._removeId(a.oldVal),b._addId(c))});this.on("nameChange.kinetic",function(a){var b=c.getStage();b&&(b._removeName(a.oldVal,c._id),b._addName(c))})},on:function(a,c){for(var b=a.split(" "),f=b.length,g=0;g<f;g++){var j=b[g].split("."),l=j[0],j=1<j.length?j[1]:"";this.eventListeners[l]||(this.eventListeners[l]=[]);this.eventListeners[l].push({name:j,handler:c})}},off:function(a){a=a.split(" ");for(var c=a.length,b=0;b<c;b++){var f=a[b],g=f.split("."),j=g[0];if(1<g.length)if(j)this.eventListeners[j]&&this._off(j,g[1]);else for(f in this.eventListeners)this._off(f,g[1]);else delete this.eventListeners[j]}},remove:function(){var a=this.getParent();if(a&&void 0!==this.index&&a.children[this.index]._id==this._id){var c=a.getStage();c&&(c._removeId(this.getId()),c._removeName(this.getName(),this._id));Kinetic.Global._removeTempNode(this);a.children.splice(this.index,1);for(a._setChildrenIndices();this.children&&0<this.children.length;)this.children[0].remove();delete this.parent}},getAttrs:function(){return this.attrs},setDefaultAttrs:function(a){void 0===this.attrs&&(this.attrs={});if(a)for(var c in a)void 0===this.attrs[c]&&(this.attrs[c]=a[c])},setAttrs:function(a){if(a)for(var c in a){var b="set"+c.charAt(0).toUpperCase()+c.slice(1);if(Kinetic.Type._isFunction(this[b]))this[b](a[c]);else this.setAttr(c,a[c])}},getVisible:function(){var a=this.attrs.visible,b=this.getParent();return a&&b&&!b.getVisible()?!1:a},getListening:function(){var a=this.attrs.listening,b=this.getParent();return a&&b&&!b.getListening()?!1:a},show:function(){this.setVisible(!0)},hide:function(){this.setVisible(!1)},getZIndex:function(){return this.index},getAbsoluteZIndex:function(){function a(g){for(var j=[],l=g.length,m=0;m<l;m++){var k=g[m];f++;"Shape"!==k.nodeType&&(j=j.concat(k.getChildren()));k._id===e._id&&(m=l)}0<j.length&&j[0].getLevel()<=b&&a(j)}var b=this.getLevel();this.getStage();var e=this,f=0;"Stage"!==e.nodeType&&a(e.getStage().getChildren());return f},getLevel:function(){for(var a=0,b=this.parent;b;)a++,b=b.parent;return a},setPosition:function(){var a=Kinetic.Type._getXY([].slice.call(arguments));this.setAttr("x",a.x);this.setAttr("y",a.y)},getPosition:function(){var a=this.attrs;return{x:a.x,y:a.y}},getAbsolutePosition:function(){var a=this.getAbsoluteTransform(),b=this.getOffset();a.translate(b.x,b.y);return a.getTranslation()},setAbsolutePosition:function(){var a=Kinetic.Type._getXY([].slice.call(arguments)),b=this._clearTransform();this.attrs.x=b.x;this.attrs.y=b.y;delete b.x;delete b.y;var e=this.getAbsoluteTransform();e.invert();e.translate(a.x,a.y);a={x:this.attrs.x+e.getTranslation().x,y:this.attrs.y+e.getTranslation().y};this.setPosition(a.x,a.y);this._setTransform(b)},move:function(){var a=Kinetic.Type._getXY([].slice.call(arguments)),b=this.getX(),e=this.getY();void 0!==a.x&&(b+=a.x);void 0!==a.y&&(e+=a.y);this.setPosition(b,e)},getRotationDeg:function(){return 180*this.getRotation()/Math.PI},setRotationDeg:function(a){this.setRotation(a*Math.PI/180)},rotate:function(a){this.setRotation(this.getRotation()+a)},rotateDeg:function(a){this.setRotation(this.getRotation()+a*Math.PI/180)},moveToTop:function(){this.parent.children.splice(this.index,1);this.parent.children.push(this);this.parent._setChildrenIndices();return!0},moveUp:function(){var a=this.index,b=this.parent.getChildren().length;if(a<b-1)return this.parent.children.splice(a,1),this.parent.children.splice(a+1,0,this),this.parent._setChildrenIndices(),!0},moveDown:function(){var a=this.index;if(0<a)return this.parent.children.splice(a,1),this.parent.children.splice(a-1,0,this),this.parent._setChildrenIndices(),!0},moveToBottom:function(){var a=this.index;if(0<a)return this.parent.children.splice(a,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0},setZIndex:function(a){this.parent.children.splice(this.index,1);this.parent.children.splice(a,0,this);this.parent._setChildrenIndices()},getAbsoluteOpacity:function(){var a=this.getOpacity();this.getParent()&&(a*=this.getParent().getAbsoluteOpacity());return a},moveTo:function(a){var b=this.parent;b.children.splice(this.index,1);b._setChildrenIndices();a.children.push(this);this.index=a.children.length-1;this.parent=a;a._setChildrenIndices()},toObject:function(){var a=Kinetic.Type,b={},e=this.attrs;b.attrs={};for(var f in e){var g=e[f];if(!a._isFunction(g)&&!a._isElement(g)&&(!a._isObject(g)||!a._hasMethods(g)))b.attrs[f]=g}b.nodeType=this.nodeType;b.shapeType=this.shapeType;return b},toJSON:function(){return JSON.stringify(this.toObject())},getParent:function(){return this.parent},getLayer:function(){return this.getParent().getLayer()},getStage:function(){if(this.getParent())return this.getParent().getStage()},simulate:function(a,b){this._handleEvent(a,b||{})},fire:function(a,b){this._executeHandlers(a,b||{})},getAbsoluteTransform:function(){var a=new Kinetic.Transform,b=[],e=this.parent;for(b.unshift(this);e;)b.unshift(e),e=e.parent;for(var e=b.length,f=0;f<e;f++){var g=b[f].getTransform();a.multiply(g)}return a},getTransform:function(){var a=new Kinetic.Transform,b=this.attrs,e=b.x,f=b.y,g=b.rotation,j=b.scale,l=j.x,j=j.y,m=b.offset,b=m.x,m=m.y;(0!==e||0!==f)&&a.translate(e,f);0!==g&&a.rotate(g);(1!==l||1!==j)&&a.scale(l,j);(0!==b||0!==m)&&a.translate(-1*b,-1*m);return a},clone:function(a){var b=new Kinetic[this.shapeType||this.nodeType](this.attrs),e;for(e in this.eventListeners)for(var f=this.eventListeners[e],g=f.length,j=0;j<g;j++){var l=f[j];0>l.name.indexOf("kinetic")&&(b.eventListeners[e]||(b.eventListeners[e]=[]),b.eventListeners[e].push(l))}b.setAttrs(a);return b},toDataURL:function(a){var b=a&&a.mimeType?a.mimeType:null,e=a&&a.quality?a.quality:null;a&&a.width&&a.height?a=new Kinetic.Canvas(a.width,a.height):(a=this.getStage().bufferCanvas,a.clear());this.drawBuffer(a);return a.toDataURL(b,e)},toImage:function(a){Kinetic.Type._getImage(this.toDataURL(a),function(b){a.callback(b)})},setOffset:function(){var a=Kinetic.Type._getXY([].slice.call(arguments));void 0===a.x&&(a.x=this.getOffset().x);void 0===a.y&&(a.y=this.getOffset().y);this.setAttr("offset",a)},setScale:function(){var a=Kinetic.Type._getXY([].slice.call(arguments));void 0===a.x&&(a.x=this.getScale().x);void 0===a.y&&(a.y=this.getScale().y);this.setAttr("scale",a)},setSize:function(){var a=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setWidth(a.width);this.setHeight(a.height)},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return this.attrs.width||0},getHeight:function(){return this.attrs.height||0},_get:function(a){return this.nodeType===a?[this]:[]},_off:function(a,b){for(var e=0;e<this.eventListeners[a].length;e++)if(this.eventListeners[a][e].name===b){this.eventListeners[a].splice(e,1);if(0===this.eventListeners[a].length){delete this.eventListeners[a];break}e--}},_clearTransform:function(){var a=this.attrs,b=a.scale,e=a.offset,a={x:a.x,y:a.y,rotation:a.rotation,scale:{x:b.x,y:b.y},offset:{x:e.x,y:e.y}};this.attrs.x=0;this.attrs.y=0;this.attrs.rotation=0;this.attrs.scale={x:1,y:1};this.attrs.offset={x:0,y:0};return a},_setTransform:function(a){for(var b in a)this.attrs[b]=a[b]},_fireBeforeChangeEvent:function(a,b,e){this._handleEvent("before"+a.toUpperCase()+"Change",{oldVal:b,newVal:e})},_fireChangeEvent:function(a,b,e){this._handleEvent(a+"Change",{oldVal:b,newVal:e})},setAttr:function(a,b){if(void 0!==b){var e=this.attrs[a];this._fireBeforeChangeEvent(a,e,b);this.attrs[a]=b;this._fireChangeEvent(a,e,b)}},_handleEvent:function(a,b,e){b&&"Shape"===this.nodeType&&(b.shape=this);this.getStage();var f=this.eventListeners,g=!0;"mouseenter"===a&&e&&this._id===e._id?g=!1:"mouseleave"===a&&(e&&this._id===e._id)&&(g=!1);g&&(f[a]&&this.fire(a,b),b&&(!b.cancelBubble&&this.parent)&&(e&&e.parent?this._handleEvent.call(this.parent,a,b,e.parent):this._handleEvent.call(this.parent,a,b)))},_executeHandlers:function(a,b){for(var e=this.eventListeners[a],f=e.length,g=0;g<f;g++)e[g].handler.apply(this,[b])}};Kinetic.Node.addSetters=function(a,b){for(var e=b.length,f=0;f<e;f++)this._addSetter(a,b[f])};Kinetic.Node.addGetters=function(a,b){for(var e=b.length,f=0;f<e;f++)this._addGetter(a,b[f])};Kinetic.Node.addGettersSetters=function(a,b){this.addSetters(a,b);this.addGetters(a,b)};Kinetic.Node._addSetter=function(a,b){var e="set"+b.charAt(0).toUpperCase()+b.slice(1);a.prototype[e]=function(a){this.setAttr(b,a)}};Kinetic.Node._addGetter=function(a,b){var e="get"+b.charAt(0).toUpperCase()+b.slice(1);a.prototype[e]=function(){return this.attrs[b]}};Kinetic.Node.create=function(a,b){return this._createNode(JSON.parse(a),b)};Kinetic.Node._createNode=function(a,b){var e;e="Shape"===a.nodeType?void 0===a.shapeType?"Shape":a.shapeType:a.nodeType;b&&(a.attrs.container=b);e=new Kinetic[e](a.attrs);if(a.children)for(var f=a.children.length,g=0;g<f;g++)e.add(this._createNode(a.children[g]));return e};Kinetic.Node.addGettersSetters(Kinetic.Node,"x y rotation opacity name id".split(" "));Kinetic.Node.addGetters(Kinetic.Node,["scale","offset"]);Kinetic.Node.addSetters(Kinetic.Node,["width","height","listening","visible"]);Kinetic.Node.prototype.isListening=Kinetic.Node.prototype.getListening;Kinetic.Node.prototype.isVisible=Kinetic.Node.prototype.getVisible;for(var a=["on","off"],b=0;2>b;b++)(function(b){var c=a[b];Kinetic.Collection.prototype[c]=function(){var a=[].slice.call(arguments);a.unshift(c);this.apply.apply(this,a)}})(b)})();Kinetic.DD={anim:new Kinetic.Animation,moving:!1,offset:{x:0,y:0}};Kinetic.DD._startDrag=function(a){var b=Kinetic.DD,d=b.node;if(d){var c=d.getStage().getUserPosition(),e=d.attrs.dragBoundFunc,c={x:c.x-b.offset.x,y:c.y-b.offset.y};void 0!==e&&(c=e.call(d,c,a));d.setAbsolutePosition(c);b.moving||(b.moving=!0,d.setListening(!1),d._handleEvent("dragstart",a));d._handleEvent("dragmove",a)}};Kinetic.DD._endDrag=function(a){var b=Kinetic.DD,d=b.node;d&&(d.setListening(!0),"Stage"===d.nodeType?d.draw():d.getLayer().draw(),b.moving&&(b.moving=!1,d._handleEvent("dragend",a)));b.node=null;b.anim.stop()};Kinetic.Node.prototype.setDraggable=function(a){this.setAttr("draggable",a);this._dragChange()};Kinetic.Node.prototype.getDraggable=function(){return this.attrs.draggable};Kinetic.Node.prototype.isDragging=function(){var a=Kinetic.DD;return a.node&&a.node._id===this._id&&a.moving};Kinetic.Node.prototype._listenDrag=function(){this._dragCleanup();var a=this;this.on("mousedown.kinetic touchstart.kinetic",function(){a._initDrag()})};Kinetic.Node.prototype._initDrag=function(){var a=Kinetic.DD,b=this.getStage().getUserPosition();if(b){this.getTransform().getTranslation();this.getAbsoluteTransform().getTranslation();var d=this.getAbsolutePosition();a.node=this;a.offset.x=b.x-d.x;a.offset.y=b.y-d.y;a.anim.node="Stage"===this.nodeType?this:this.getLayer();a.anim.start()}};Kinetic.Node.prototype._dragChange=function(){if(this.attrs.draggable)this._listenDrag();else{this._dragCleanup();var a=this.getStage(),b=Kinetic.DD;a&&(b.node&&b.node._id===this._id)&&b._endDrag()}};Kinetic.Node.prototype._dragCleanup=function(){this.off("mousedown.kinetic");this.off("touchstart.kinetic")};Kinetic.Node.prototype.isDraggable=Kinetic.Node.prototype.getDraggable;Kinetic.Node.addGettersSetters(Kinetic.Node,["dragBoundFunc"]);Kinetic.Transition=function(a,b){function d(a,b,e,f){for(var k in a)"duration"!==k&&("easing"!==k&&"callback"!==k)&&(Kinetic.Type._isObject(a[k])?(e[k]={},d(a[k],b[k],e[k],f)):c._add(c._getTween(b,k,a[k],e,f)))}this.node=a;this.config=b;this.tweens=[];var c=this,e={};d(b,a.attrs,e,e);for(var f=0,e=0;e<this.tweens.length;e++)this.tweens[e].onFinished=function(){f++;if(f>=c.tweens.length)c.onFinished()}};Kinetic.Transition.prototype={start:function(){for(var a=0;a<this.tweens.length;a++)this.tweens[a].start()},stop:function(){for(var a=0;a<this.tweens.length;a++)this.tweens[a].stop()},resume:function(){for(var a=0;a<this.tweens.length;a++)this.tweens[a].resume()},_onEnterFrame:function(){for(var a=0;a<this.tweens.length;a++)this.tweens[a].onEnterFrame()},_add:function(a){this.tweens.push(a)},_getTween:function(a,b,d,c,e){var f=this.config,g=this.node,j=f.easing;void 0===j&&(j="linear");return new Kinetic.Tween(g,function(a){c[b]=a;g.setAttrs(e)},Kinetic.Tweens[j],a[b],d,f.duration)}};Kinetic.Node.prototype.transitionTo=function(a){this.transAnim||(this.transAnim=new Kinetic.Animation);var b="Stage"===this.nodeType?this:this.getLayer(),d=this,c=new Kinetic.Transition(this,a);this.transAnim.func=function(){c._onEnterFrame()};this.transAnim.node=b;c.onFinished=function(){d.transAnim.stop();a.callback&&a.callback()};c.start();this.transAnim.start();return c};Kinetic.Container=function(a){this._containerInit(a)};Kinetic.Container.prototype={_containerInit:function(a){this.children=[];Kinetic.Node.call(this,a)},getChildren:function(){return this.children},removeChildren:function(){for(;0<this.children.length;)this.children[0].remove()},add:function(a){var b=Kinetic.Global,d=this.children;a._id=Kinetic.Global.idCounter++;a.index=d.length;a.parent=this;d.push(a);(d=a.getStage())?(d._addId(a),d._addName(a),b._pullNodes(d)):b._addTempNode(a);return this},get:function(a){var b=new Kinetic.Collection;if("#"===a.charAt(0))(a=this._getNodeById(a.slice(1)))&&b.push(a);else if("."===a.charAt(0))a=this._getNodesByName(a.slice(1)),Kinetic.Collection.apply(b,a);else{for(var d=[],c=this.getChildren(),e=c.length,f=0;f<e;f++)d=d.concat(c[f]._get(a));Kinetic.Collection.apply(b,d)}return b},_getNodeById:function(a){var b=this.getStage();return void 0!==b.ids[a]&&this.isAncestorOf(b.ids[a])?b.ids[a]:null},_getNodesByName:function(a){a=this.getStage().names[a]||[];return this._getDescendants(a)},_get:function(a){for(var b=Kinetic.Node.prototype._get.call(this,a),d=this.getChildren(),c=d.length,e=0;e<c;e++)b=b.concat(d[e]._get(a));return b},toObject:function(){var a=Kinetic.Node.prototype.toObject.call(this);a.children=[];for(var b=this.getChildren(),d=b.length,c=0;c<d;c++)a.children.push(b[c].toObject());return a},_getDescendants:function(a){for(var b=[],d=a.length,c=0;c<d;c++){var e=a[c];this.isAncestorOf(e)&&b.push(e)}return b},isAncestorOf:function(a){for(a=a.getParent();a;){if(a._id===this._id)return!0;a=a.getParent()}return!1},clone:function(a){a=Kinetic.Node.prototype.clone.call(this,a);for(var b in this.children)a.add(this.children[b].clone());return a},getIntersections:function(){for(var a=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),b=[],d=this.get("Shape"),c=d.length,e=0;e<c;e++){var f=d[e];f.isVisible()&&f.intersects(a)&&b.push(f)}return b},_setChildrenIndices:function(){for(var a=this.children,b=a.length,d=0;d<b;d++)a[d].index=d},draw:function(){this.drawScene();this.drawHit()},drawScene:function(){if(this.isVisible())for(var a=this.children,b=a.length,d=0;d<b;d++)a[d].drawScene()},drawHit:function(){if(this.isVisible()&&this.isListening())for(var a=this.children,b=a.length,d=0;d<b;d++)a[d].drawHit()},drawBuffer:function(a){if(this.isVisible())for(var b=this.children,d=b.length,c=0;c<d;c++)b[c].drawBuffer(a)}};Kinetic.Global.extend(Kinetic.Container,Kinetic.Node);Kinetic.Stage=function(a){this._initStage(a)};Kinetic.Stage.prototype={_initStage:function(a){this.setDefaultAttrs({width:400,height:200});Kinetic.Container.call(this,a);this._setStageDefaultProperties();this._id=Kinetic.Global.idCounter++;this._buildDOM();this._bindContentEvents();Kinetic.Global.stages.push(this);this._addId(this);this._addName(this)},setContainer:function(a){"string"===typeof a&&(a=document.getElementById(a));this.setAttr("container",a)},setHeight:function(a){Kinetic.Node.prototype.setHeight.call(this,a);this._resizeDOM()},setWidth:function(a){Kinetic.Node.prototype.setWidth.call(this,a);this._resizeDOM()},clear:function(){for(var a=this.children,b=0;b<a.length;b++)a[b].clear()},reset:function(){this.removeChildren();this._setStageDefaultProperties();this.setAttrs(this.defaultNodeAttrs)},getMousePosition:function(){return this.mousePos},getTouchPosition:function(){return this.touchPos},getUserPosition:function(){return this.getTouchPosition()||this.getMousePosition()},getStage:function(){return this},getDOM:function(){return this.content},toDataURL:function(a){function b(j){var l=g[j].toDataURL(),m=new Image;m.onload=function(){f.drawImage(m,0,0);j<g.length-1?b(j+1):a.callback(e.toDataURL(d,c))};m.src=l}var d=a&&a.mimeType?a.mimeType:null,c=a&&a.quality?a.quality:null,e=new Kinetic.Canvas(a&&a.width?a.width:this.attrs.width,a&&a.height?a.height:this.attrs.height),f=e.getContext(),g=this.children;b(0)},toImage:function(a){this.toDataURL({callback:function(b){Kinetic.Type._getImage(b,function(b){a.callback(b)})}})},getIntersection:function(a){for(var b=this.getChildren(),d=b.length-1;0<=d;d--){var c=b[d];if(c.isVisible()&&c.isListening()){c=c.hitCanvas.context.getImageData(Math.round(a.x),Math.round(a.y),1,1).data;if(255===c[3])return a=Kinetic.Type._rgbToHex(c[0],c[1],c[2]),a=Kinetic.Global.shapes[a],{shape:a,pixel:c};if(0<c[0]||0<c[1]||0<c[2]||0<c[3])return{pixel:c}}}return null},_getNodeById:function(a){return this.ids[a]||null},_getNodesByName:function(a){return this.names[a]||[]},_resizeDOM:function(){if(this.content){var a=this.attrs.width,b=this.attrs.height;this.content.style.width=a+"px";this.content.style.height=b+"px";this.bufferCanvas.setSize(a,b);this.hitCanvas.setSize(a,b);for(var d=this.children,c=0;c<d.length;c++){var e=d[c];e.getCanvas().setSize(a,b);e.hitCanvas.setSize(a,b);e.draw()}}},add:function(a){Kinetic.Container.prototype.add.call(this,a);a.canvas.setSize(this.attrs.width,this.attrs.height);a.hitCanvas.setSize(this.attrs.width,this.attrs.height);a.draw();this.content.appendChild(a.canvas.element);return this},_setUserPosition:function(a){a||(a=window.event);this._setMousePosition(a);this._setTouchPosition(a)},_bindContentEvents:function(){for(var a=this,b="mousedown mousemove mouseup mouseout touchstart touchmove touchend".split(" "),d=0;d<b.length;d++){var c=b[d];(function(){var b=c;a.content.addEventListener(b,function(c){a["_"+b](c)},!1)})()}},_mouseout:function(a){this._setUserPosition(a);var b=Kinetic.DD,d=this.targetShape;if(d&&(!b||!b.moving))d._handleEvent("mouseout",a),d._handleEvent("mouseleave",a),this.targetShape=null;this.mousePos=void 0},_mousemove:function(a){this._setUserPosition(a);var b=Kinetic.DD,d=this.getIntersection(this.getUserPosition());if(d){var c=d.shape;c&&((!b||!b.moving)&&255===d.pixel[3]&&(!this.targetShape||this.targetShape._id!==c._id)?(this.targetShape&&(this.targetShape._handleEvent("mouseout",a,c),this.targetShape._handleEvent("mouseleave",a,c)),c._handleEvent("mouseover",a,this.targetShape),c._handleEvent("mouseenter",a,this.targetShape),this.targetShape=c):c._handleEvent("mousemove",a))}else if(this.targetShape&&(!b||!b.moving))this.targetShape._handleEvent("mouseout",a),this.targetShape._handleEvent("mouseleave",a),this.targetShape=null;b&&b._startDrag(a)},_mousedown:function(a){this._setUserPosition(a);var b=this.getIntersection(this.getUserPosition());b&&b.shape&&(b=b.shape,this.clickStart=!0,b._handleEvent("mousedown",a));Kinetic.DD&&this.attrs.draggable&&this._initDrag()},_mouseup:function(a){this._setUserPosition(a);var b=Kinetic.DD,d=this.getIntersection(this.getUserPosition()),c=this;if(d&&d.shape&&(d=d.shape,d._handleEvent("mouseup",a),this.clickStart&&(!b||!b.moving||!b.node)))d._handleEvent("click",a),this.inDoubleClickWindow&&d._handleEvent("dblclick",a),this.inDoubleClickWindow=!0,setTimeout(function(){c.inDoubleClickWindow=!1},this.dblClickWindow);this.clickStart=!1;b&&b._endDrag(a)},_touchstart:function(a){this._setUserPosition(a);a.preventDefault();var b=this.getIntersection(this.getUserPosition());b&&b.shape&&(b=b.shape,this.tapStart=!0,b._handleEvent("touchstart",a));Kinetic.DD&&this.attrs.draggable&&this._initDrag()},_touchend:function(a){this._setUserPosition(a);var b=Kinetic.DD,d=this.getIntersection(this.getUserPosition()),c=this;if(d&&d.shape&&(d=d.shape,d._handleEvent("touchend",a),this.tapStart&&(!b||!b.moving||!b.node)))d._handleEvent("tap",a),this.inDoubleClickWindow&&d._handleEvent("dbltap",a),this.inDoubleClickWindow=!0,setTimeout(function(){c.inDoubleClickWindow=!1},this.dblClickWindow);this.tapStart=!1;b&&b._endDrag(a)},_touchmove:function(a){this._setUserPosition(a);var b=Kinetic.DD;a.preventDefault();var d=this.getIntersection(this.getUserPosition());d&&d.shape&&d.shape._handleEvent("touchmove",a);b&&b._startDrag(a)},_setMousePosition:function(a){var b=a.clientX-this._getContentPosition().left;a=a.clientY-this._getContentPosition().top;this.mousePos={x:b,y:a}},_setTouchPosition:function(a){if(void 0!==a.touches&&1===a.touches.length){var b=a.touches[0];a=b.clientX-this._getContentPosition().left;b=b.clientY-this._getContentPosition().top;this.touchPos={x:a,y:b}}},_getContentPosition:function(){var a=this.content.getBoundingClientRect();return{top:a.top,left:a.left}},_buildDOM:function(){this.content=document.createElement("div");this.content.style.position="relative";this.content.style.display="inline-block";this.content.className="kineticjs-content";this.attrs.container.appendChild(this.content);this.bufferCanvas=new Kinetic.Canvas;this.hitCanvas=new Kinetic.Canvas(0,0,!0);this._resizeDOM()},_addId:function(a){void 0!==a.attrs.id&&(this.ids[a.attrs.id]=a)},_removeId:function(a){void 0!==a&&delete this.ids[a]},_addName:function(a){var b=a.attrs.name;void 0!==b&&(void 0===this.names[b]&&(this.names[b]=[]),this.names[b].push(a))},_removeName:function(a,b){if(void 0!==a){var d=this.names[a];if(void 0!==d){for(var c=0;c<d.length;c++)d[c]._id===b&&d.splice(c,1);0===d.length&&delete this.names[a]}}},_onContent:function(a,b){for(var d=a.split(" "),c=0;c<d.length;c++)this.content.addEventListener(d[c],b,!1)},_setStageDefaultProperties:function(){this.nodeType="Stage";this.dblClickWindow=400;this.targetShape=null;this.mousePos=void 0;this.clickStart=!1;this.touchPos=void 0;this.tapStart=!1;this.ids={};this.names={}}};Kinetic.Global.extend(Kinetic.Stage,Kinetic.Container);Kinetic.Node.addGetters(Kinetic.Stage,["container"]);Kinetic.Layer=function(a){this._initLayer(a)};Kinetic.Layer.prototype={_initLayer:function(a){this.setDefaultAttrs({clearBeforeDraw:!0});this.nodeType="Layer";this.afterDrawFunc=this.beforeDrawFunc=void 0;this.canvas=new Kinetic.Canvas;this.canvas.getElement().style.position="absolute";this.hitCanvas=new Kinetic.Canvas(0,0,!0);Kinetic.Container.call(this,a)},draw:function(){void 0!==this.beforeDrawFunc&&this.beforeDrawFunc.call(this);Kinetic.Container.prototype.draw.call(this);void 0!==this.afterDrawFunc&&this.afterDrawFunc.call(this)},drawHit:function(){this.hitCanvas.clear();Kinetic.Container.prototype.drawHit.call(this)},drawScene:function(){this.attrs.clearBeforeDraw&&this.getCanvas().clear();Kinetic.Container.prototype.drawScene.call(this)},beforeDraw:function(a){this.beforeDrawFunc=a},afterDraw:function(a){this.afterDrawFunc=a},getCanvas:function(){return this.canvas},getContext:function(){return this.canvas.context},clear:function(){this.getCanvas().clear()},setVisible:function(a){Kinetic.Node.prototype.setVisible.call(this,a);a?(this.canvas.element.style.display="block",this.hitCanvas.element.style.display="block"):(this.canvas.element.style.display="none",this.hitCanvas.element.style.display="none")},setZIndex:function(a){Kinetic.Node.prototype.setZIndex.call(this,a);var b=this.getStage();b&&(b.content.removeChild(this.canvas.element),a<b.getChildren().length-1?b.content.insertBefore(this.canvas.element,b.getChildren()[a+1].canvas.element):b.content.appendChild(this.canvas.element))},moveToTop:function(){Kinetic.Node.prototype.moveToTop.call(this);var a=this.getStage();a&&(a.content.removeChild(this.canvas.element),a.content.appendChild(this.canvas.element))},moveUp:function(){if(Kinetic.Node.prototype.moveUp.call(this)){var a=this.getStage();a&&(a.content.removeChild(this.canvas.element),this.index<a.getChildren().length-1?a.content.insertBefore(this.canvas.element,a.getChildren()[this.index+1].canvas.element):a.content.appendChild(this.canvas.element))}},moveDown:function(){if(Kinetic.Node.prototype.moveDown.call(this)){var a=this.getStage();if(a){var b=a.getChildren();a.content.removeChild(this.canvas.element);a.content.insertBefore(this.canvas.element,b[this.index+1].canvas.element)}}},moveToBottom:function(){if(Kinetic.Node.prototype.moveToBottom.call(this)){var a=this.getStage();if(a){var b=a.getChildren();a.content.removeChild(this.canvas.element);a.content.insertBefore(this.canvas.element,b[1].canvas.element)}}},getLayer:function(){return this},toDataURL:function(a){var b=a&&a.mimeType?a.mimeType:null,d=a&&a.quality?a.quality:null;this.isVisible()?a&&a.width&&a.height?(a=new Kinetic.Canvas(a.width,a.height),this.draw(a)):a=this.getCanvas():(a=this.getStage(),a=new Kinetic.Canvas(a.getWidth(),a.getHeight()));return a.toDataURL(b,d)},remove:function(){var a=this.getStage();Kinetic.Node.prototype.remove.call(this);try{a.content.removeChild(this.canvas.element)}catch(b){Kinetic.Global.warn("unable to remove layer scene canvas element from the document")}}};Kinetic.Global.extend(Kinetic.Layer,Kinetic.Container);Kinetic.Node.addGettersSetters(Kinetic.Layer,["clearBeforeDraw"]);Kinetic.Group=function(a){this._initGroup(a)};Kinetic.Group.prototype={_initGroup:function(a){this.nodeType="Group";Kinetic.Container.call(this,a)}};Kinetic.Global.extend(Kinetic.Group,Kinetic.Container);(function(){Kinetic.Shape=function(a){this._initShape(a)};Kinetic.Shape.prototype={_initShape:function(a){this.nodeType="Shape";for(var b=Kinetic.Global.shapes,d;!(d=Kinetic.Type._getRandomColorKey())||d in b;);this.colorKey=d;b[d]=this;Kinetic.Node.call(this,a)},getContext:function(){return this.getLayer().getContext()},getCanvas:function(){return this.getLayer().getCanvas()},_getFillType:function(a){var b=Kinetic.Type;if(a)return b._isString(a)?"COLOR":a.image?"PATTERN":a.start&&a.end&&!a.start.radius&&!a.end.radius?"LINEAR_GRADIENT":a.start&&a.end&&b._isNumber(a.start.radius)&&b._isNumber(a.end.radius)?"RADIAL_GRADIENT":"UNKNOWN"},fill:function(a){a.renderer._fill(this)},stroke:function(a){a.renderer._stroke(this)},fillStroke:function(a){a.renderer._fill(this);a.renderer._stroke(this,this.getShadow()&&this.getFill())},applyShadow:function(a,b){a.save();a.renderer._applyShadow(this);b();a.restore();b()},drawImage:function(){var a=arguments[0];a.save();var b=Array.prototype.slice.call(arguments);if(6===b.length||10===b.length)6===b.length?a.drawImage(b[1],b[2],b[3],b[4],b[5]):a.drawImage(b[1],b[2],b[3],b[4],b[5],b[6],b[7],b[8],b[9]);a.restore()},_applyOpacity:function(a){var b=this.getAbsoluteOpacity();1!==b&&(a.globalAlpha=b)},_applyLineJoin:function(a){var b=this.getLineJoin();b&&(a.lineJoin=b)},_applyLineCap:function(a){var b=this.getLineCap();b&&(a.lineCap=b)},setShadow:function(a){var b=Kinetic.Type;void 0!==a.offset&&(a.offset=b._getXY(a.offset));this.setAttr("shadow",b._merge(a,this.getShadow()))},setFill:function(a){var b=Kinetic.Type,d=this.getFill(),c=this._getFillType(a),e=this._getFillType(d),f="COLOR"===c||"COLOR"===e,c=c===e||"UNKNOWN"===c;void 0!==a.offset&&(a.offset=b._getXY(a.offset));!f&&c&&(a=b._merge(a,d));this.setAttr("fill",a)},setSize:function(){var a=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setWidth(a.width);this.setHeight(a.height)},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},_get:function(a){return this.nodeType===a||this.shapeType===a?[this]:[]},intersects:function(){var a=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),b=this.getStage().hitCanvas;b.clear();this.drawBuffer(b);return 0<b.context.getImageData(Math.round(a.x),Math.round(a.y),1,1).data[3]},remove:function(){Kinetic.Node.prototype.remove.call(this);delete Kinetic.Global.shapes[this.colorKey]},drawBuffer:function(a){var b=this.attrs.drawFunc;a=a.getContext();if(b&&this.isVisible()){this.getStage();var d=[],c=this.parent;for(d.unshift(this);c;)d.unshift(c),c=c.parent;a.save();this._applyOpacity(a);this._applyLineJoin(a);this._applyLineCap(a);for(var c=d.length,e=0;e<c;e++){var f=d[e].getTransform().getMatrix();a.transform(f[0],f[1],f[2],f[3],f[4],f[5])}b.call(this,a);a.restore()}},drawScene:function(){var a=this.attrs.drawFunc,b=this.getLayer().getCanvas().getContext();if(a&&this.isVisible()){this.getStage();var d=[],c=this.parent;for(d.unshift(this);c;)d.unshift(c),c=c.parent;b.save();this._applyOpacity(b);this._applyLineJoin(b);this._applyLineCap(b);for(var c=d.length,e=0;e<c;e++){var f=d[e].getTransform().getMatrix();b.transform(f[0],f[1],f[2],f[3],f[4],f[5])}a.call(this,b);b.restore()}},drawHit:function(){var a=this.attrs,a=a.drawHitFunc||a.drawFunc,b=this.getLayer().hitCanvas.getContext();if(a&&this.isVisible()&&this.isListening()){this.getStage();var d=[],c=this.parent;for(d.unshift(this);c;)d.unshift(c),c=c.parent;b.save();this._applyLineJoin(b);this._applyLineCap(b);for(var c=d.length,e=0;e<c;e++){var f=d[e].getTransform().getMatrix();b.transform(f[0],f[1],f[2],f[3],f[4],f[5])}a.call(this,b);b.restore()}},_setDrawFuncs:function(){!this.attrs.drawFunc&&this.drawFunc&&this.setDrawFunc(this.drawFunc);!this.attrs.drawHitFunc&&this.drawHitFunc&&this.setDrawHitFunc(this.drawHitFunc)}};Kinetic.Global.extend(Kinetic.Shape,Kinetic.Node);Kinetic.Node.addGettersSetters(Kinetic.Shape,"stroke lineJoin lineCap strokeWidth drawFunc drawHitFunc cornerRadius".split(" "));Kinetic.Node.addGetters(Kinetic.Shape,["shadow","fill"])})();Kinetic.Rect=function(a){this._initRect(a)};Kinetic.Rect.prototype={_initRect:function(a){this.setDefaultAttrs({width:0,height:0,cornerRadius:0});this.shapeType="Rect";Kinetic.Shape.call(this,a);this._setDrawFuncs()},drawFunc:function(a){a.beginPath();var b=this.getCornerRadius(),d=this.getWidth(),c=this.getHeight();0===b?a.rect(0,0,d,c):(a.moveTo(b,0),a.lineTo(d-b,0),a.arc(d-b,b,b,3*Math.PI/2,0,!1),a.lineTo(d,c-b),a.arc(d-b,c-b,b,0,Math.PI/2,!1),a.lineTo(b,c),a.arc(b,c-b,b,Math.PI/2,Math.PI,!1),a.lineTo(0,b),a.arc(b,b,b,Math.PI,3*Math.PI/2,!1));a.closePath();this.fillStroke(a)}};Kinetic.Global.extend(Kinetic.Rect,Kinetic.Shape);Kinetic.Circle=function(a){this._initCircle(a)};Kinetic.Circle.prototype={_initCircle:function(a){this.setDefaultAttrs({radius:0});this.shapeType="Circle";Kinetic.Shape.call(this,a);this._setDrawFuncs()},drawFunc:function(a){a.beginPath();a.arc(0,0,this.getRadius(),0,2*Math.PI,!0);a.closePath();this.fillStroke(a)},getWidth:function(){return 2*this.getRadius()},getHeight:function(){return 2*this.getRadius()},setWidth:function(a){Kinetic.Node.prototype.setWidth.call(this,a);this.setRadius(a/2)},setHeight:function(a){Kinetic.Node.prototype.setHeight.call(this,a);this.setRadius(a/2)}};Kinetic.Global.extend(Kinetic.Circle,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Circle,["radius"]);Kinetic.Ellipse=function(a){this._initEllipse(a)};Kinetic.Ellipse.prototype={_initEllipse:function(a){this.setDefaultAttrs({radius:{x:0,y:0}});this.shapeType="Ellipse";Kinetic.Shape.call(this,a);this._setDrawFuncs()},drawFunc:function(a){var b=this.getRadius();a.beginPath();a.save();b.x!==b.y&&a.scale(1,b.y/b.x);a.arc(0,0,b.x,0,2*Math.PI,!0);a.restore();a.closePath();this.fillStroke(a)},setRadius:function(){var a=Kinetic.Type._getXY([].slice.call(arguments));this.setAttr("radius",Kinetic.Type._merge(a,this.getRadius()))},getWidth:function(){return 2*this.getRadius().x},getHeight:function(){return 2*this.getRadius().y},setWidth:function(a){Kinetic.Node.prototype.setWidth.call(this,a);this.setRadius({x:a/2})},setHeight:function(a){Kinetic.Node.prototype.setHeight.call(this,a);this.setRadius({y:a/2})}};Kinetic.Global.extend(Kinetic.Ellipse,Kinetic.Shape);Kinetic.Node.addGetters(Kinetic.Ellipse,["radius"]);Kinetic.Image=function(a){this._initImage(a)};Kinetic.Image.prototype={_initImage:function(a){this.shapeType="Image";Kinetic.Shape.call(this,a);this._setDrawFuncs();var b=this;this.on("imageChange",function(){b._syncSize()});this._syncSize()},drawFunc:function(a){var b=this.getWidth(),d=this.getHeight(),c,e=this;a.beginPath();a.rect(0,0,b,d);a.closePath();this.fillStroke(a);this.attrs.image&&(c=this.attrs.crop&&this.attrs.crop.width&&this.attrs.crop.height?[a,this.attrs.image,this.attrs.crop.x?this.attrs.crop.x:0,this.attrs.crop.y?this.attrs.crop.y:0,this.attrs.crop.width,this.attrs.crop.height,0,0,b,d]:[a,this.attrs.image,0,0,b,d],this.getShadow()?this.applyShadow(a,function(){e.drawImage.apply(e,c)}):this.drawImage.apply(this,c))},drawHitFunc:function(a){var b=this.getWidth(),d=this.getHeight(),c=this.imageHitRegion;c?(this.drawImage(a,c,0,0,b,d),a.beginPath(),a.rect(0,0,b,d),a.closePath(),this.stroke(a)):(a.beginPath(),a.rect(0,0,b,d),a.closePath(),this.fillStroke(a))},applyFilter:function(a,b,d){var c=new Kinetic.Canvas(this.attrs.image.width,this.attrs.image.height),e=c.getContext();e.drawImage(this.attrs.image,0,0);try{var f=e.getImageData(0,0,c.getWidth(),c.getHeight());a(f,b);var g=this;Kinetic.Type._getImage(f,function(a){g.setImage(a);d&&d()})}catch(j){Kinetic.Global.warn("Unable to apply filter. "+j.message)}},setCrop:function(){var a=[].slice.call(arguments),b=Kinetic.Type._getXY(a),a=Kinetic.Type._getSize(a),b=Kinetic.Type._merge(b,a);this.setAttr("crop",Kinetic.Type._merge(b,this.getCrop()))},createImageHitRegion:function(a){var b=new Kinetic.Canvas(this.attrs.width,this.attrs.height),d=b.getContext();d.drawImage(this.attrs.image,0,0);try{for(var c=d.getImageData(0,0,b.getWidth(),b.getHeight()),e=c.data,f=Kinetic.Type._hexToRgb(this.colorKey),b=0,g=e.length;b<g;b+=4)e[b]=f.r,e[b+1]=f.g,e[b+2]=f.b;var j=this;Kinetic.Type._getImage(c,function(b){j.imageHitRegion=b;a&&a()})}catch(l){Kinetic.Global.warn("Unable to create image hit region. "+l.message)}},clearImageHitRegion:function(){delete this.imageHitRegion},_syncSize:function(){this.attrs.image&&(this.attrs.width||this.setWidth(this.attrs.image.width),this.attrs.height||this.setHeight(this.attrs.image.height))}};Kinetic.Global.extend(Kinetic.Image,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Image,["image"]);Kinetic.Node.addGetters(Kinetic.Image,["crop"]);Kinetic.Polygon=function(a){this._initPolygon(a)};Kinetic.Polygon.prototype={_initPolygon:function(a){this.setDefaultAttrs({points:[]});this.shapeType="Polygon";Kinetic.Shape.call(this,a);this._setDrawFuncs()},drawFunc:function(a){a.beginPath();a.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var b=1;b<this.attrs.points.length;b++)a.lineTo(this.attrs.points[b].x,this.attrs.points[b].y);a.closePath();this.fillStroke(a)},setPoints:function(a){this.setAttr("points",Kinetic.Type._getPoints(a))}};Kinetic.Global.extend(Kinetic.Polygon,Kinetic.Shape);Kinetic.Node.addGetters(Kinetic.Polygon,["points"]);Kinetic.Text=function(a){this._initText(a)};Kinetic.Text.prototype={_initText:function(a){this.setDefaultAttrs({fontFamily:"Calibri",text:"",fontSize:12,align:"left",verticalAlign:"top",fontStyle:"normal",padding:0,width:"auto",height:"auto",detectionType:"path",cornerRadius:0,lineHeight:1.2});this.dummyCanvas=document.createElement("canvas");this.shapeType="Text";Kinetic.Shape.call(this,a);this._setDrawFuncs();a="fontFamily fontSize fontStyle padding align lineHeight text width height".split(" ");for(var b=0;b<a.length;b++)this.on(a[b]+"Change.kinetic",this._setTextData);this._setTextData()},drawFunc:function(a){Kinetic.Rect.prototype.drawFunc.call(this,a);var b=this.attrs.padding,d=this.attrs.lineHeight*this.getTextHeight(),c=this.textArr;a.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;a.textBaseline="middle";a.textAlign="left";a.save();a.translate(b,0);a.translate(0,b+this.getTextHeight()/2);for(var e=0;e<c.length;e++){var f=c[e];a.save();"right"===this.attrs.align?a.translate(this.getWidth()-this._getTextSize(f).width-2*b,0):"center"===this.attrs.align&&a.translate((this.getWidth()-this._getTextSize(f).width-2*b)/2,0);this.fillStrokeText(a,f);a.restore();a.translate(0,d)}a.restore()},drawHitFunc:Kinetic.Rect.prototype.drawFunc,setText:function(a){a=Kinetic.Type._isString(a)?a:a.toString();this.setAttr("text",a)},getWidth:function(){return"auto"===this.attrs.width?this.getTextWidth()+2*this.attrs.padding:this.attrs.width},getHeight:function(){return"auto"===this.attrs.height?this.getTextHeight()*this.textArr.length*this.attrs.lineHeight+2*this.attrs.padding:this.attrs.height},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(a){var b=this.dummyCanvas.getContext("2d");b.save();b.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;a=b.measureText(a);b.restore();return{width:a.width,height:parseInt(this.attrs.fontSize,10)}},fillText:function(a,b,d){var c=this.getTextFill(),e=this.getTextShadow();c&&(a.save(),!d&&e&&this._applyTextShadow(a),a.fillStyle=c,a.fillText(b,0,0),a.restore(),!d&&(e&&e.opacity)&&this.fillText(a,b,!0))},strokeText:function(a,b,d){var c=this.getTextStroke(),e=this.getTextStrokeWidth(),f=this.getTextShadow();if(c||e)a.save(),!d&&f&&this._applyTextShadow(a),a.lineWidth=e||2,a.strokeStyle=c||"black",a.strokeText(b,0,0),a.restore(),!d&&(f&&f.opacity)&&this.strokeText(a,b,!0)},fillStrokeText:function(a,b){this.fillText(a,b);this.strokeText(a,b,this.getTextShadow()&&this.getTextFill())},setTextShadow:function(a){var b=Kinetic.Type;void 0!==a.offset&&(a.offset=b._getXY(a.offset));this.setAttr("textShadow",b._merge(a,this.getTextShadow()))},_setTextData:function(){var a=this.attrs.text.split(""),b=[],d=0,c=!0;this.textWidth=0;this.textHeight=this._getTextSize(this.attrs.text).height;for(var e=this.attrs.lineHeight*this.textHeight;0<a.length&&c&&("auto"===this.attrs.height||e*(d+1)<this.attrs.height-2*this.attrs.padding);){for(var f=0,g=void 0,c=!1;f<a.length;){if(a.indexOf("\n")===f){a.splice(f,1);g=a.splice(0,f).join("");break}var j=a.slice(0,f);if("auto"!==this.attrs.width&&this._getTextSize(j.join("")).width>this.attrs.width-2*this.attrs.padding){if(0==f)break;g=j.lastIndexOf(" ");j=j.lastIndexOf("-");j=Math.max(g,j);if(0<=j){g=a.splice(0,1+j).join("");break}g=a.splice(0,f).join("");break}f++;f===a.length&&(g=a.splice(0,f).join(""))}this.textWidth=Math.max(this.textWidth,this._getTextSize(g).width);void 0!==g&&(b.push(g),c=!0);d++}this.textArr=b},_applyTextShadow:function(a){var b=this.getTextShadow();if(b){var d=this.getAbsoluteOpacity(),c=b.color||"black",e=b.blur||5,f=b.offset||{x:0,y:0};b.opacity&&(a.globalAlpha=b.opacity*d);a.shadowColor=c;a.shadowBlur=e;a.shadowOffsetX=f.x;a.shadowOffsetY=f.y}}};Kinetic.Global.extend(Kinetic.Text,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Text,"fontFamily fontSize fontStyle textFill textStroke textStrokeWidth padding align lineHeight".split(" "));Kinetic.Node.addGetters(Kinetic.Text,["text","textShadow"]);Kinetic.Line=function(a){this._initLine(a)};Kinetic.Line.prototype={_initLine:function(a){this.setDefaultAttrs({points:[],lineCap:"butt",dashArray:[],detectionType:"pixel"});this.shapeType="Line";Kinetic.Shape.call(this,a);this._setDrawFuncs()},drawFunc:function(a){a.beginPath();a.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var b=1;b<this.attrs.points.length;b++){var d=this.attrs.points[b].x,c=this.attrs.points[b].y;0<this.attrs.dashArray.length?this._dashedLine(a,this.attrs.points[b-1].x,this.attrs.points[b-1].y,d,c,this.attrs.dashArray):a.lineTo(d,c)}this.stroke(a)},setPoints:function(a){this.setAttr("points",Kinetic.Type._getPoints(a))},_dashedLine:function(a,b,d,c,e,f){var g=f.length,j=c-b,l=e-d,m=j>l,k=m?l/j:j/l;9999<k?k=9999:-9999>k&&(k=-9999);for(var n=Math.sqrt(j*j+l*l),p=0,r=!0;0.1<=n&&1E4>p;){var q=f[p++%g];0===q&&(q=0.001);q>n&&(q=n);var s=Math.sqrt(q*q/(1+k*k));m?(b+=0>j&&0>l?-1*s:s,d+=0>j&&0>l?-1*k*s:k*s):(b+=0>j&&0>l?-1*k*s:k*s,d+=0>j&&0>l?-1*s:s);a[r?"lineTo":"moveTo"](b,d);n-=q;r=!r}a.moveTo(c,e)}};Kinetic.Global.extend(Kinetic.Line,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Line,["dashArray"]);Kinetic.Node.addGetters(Kinetic.Line,["points"]);Kinetic.Sprite=function(a){this._initSprite(a)};Kinetic.Sprite.prototype={_initSprite:function(a){this.setDefaultAttrs({index:0,frameRate:17});this.shapeType="Sprite";Kinetic.Shape.call(this,a);this._setDrawFuncs();this.anim=new Kinetic.Animation;var b=this;this.on("animationChange",function(){b.setIndex(0)})},drawFunc:function(a){var b=this.attrs.animations[this.attrs.animation][this.attrs.index];this.attrs.image&&(a.beginPath(),a.rect(0,0,b.width,b.height),a.closePath(),this.drawImage(a,this.attrs.image,b.x,b.y,b.width,b.height,0,0,b.width,b.height))},drawHitFunc:function(a){var b=this.attrs.animations[this.attrs.animation][this.attrs.index];a.beginPath();a.rect(0,0,b.width,b.height);a.closePath();this.fillStroke(a)},start:function(){var a=this,b=this.getLayer();this.anim.node=b;this.interval=setInterval(function(){var b=a.attrs.index;a._updateIndex();a.afterFrameFunc&&b===a.afterFrameIndex&&(a.afterFrameFunc(),delete a.afterFrameFunc,delete a.afterFrameIndex)},1E3/this.attrs.frameRate);this.anim.start()},stop:function(){this.anim.stop();clearInterval(this.interval)},afterFrame:function(a,b){this.afterFrameIndex=a;this.afterFrameFunc=b},_updateIndex:function(){this.attrs.index<this.attrs.animations[this.attrs.animation].length-1?this.attrs.index++:this.attrs.index=0}};Kinetic.Global.extend(Kinetic.Sprite,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Sprite,["animation","animations","index"]);Kinetic.Star=function(a){this._initStar(a)};Kinetic.Star.prototype={_initStar:function(a){this.setDefaultAttrs({numPoints:0,innerRadius:0,outerRadius:0});this.shapeType="Star";Kinetic.Shape.call(this,a);this._setDrawFuncs()},drawFunc:function(a){a.beginPath();a.moveTo(0,0-this.attrs.outerRadius);for(var b=1;b<2*this.attrs.numPoints;b++){var d=0===b%2?this.attrs.outerRadius:this.attrs.innerRadius,c=d*Math.sin(b*Math.PI/this.attrs.numPoints),d=-1*d*Math.cos(b*Math.PI/this.attrs.numPoints);a.lineTo(c,d)}a.closePath();this.fillStroke(a)}};Kinetic.Global.extend(Kinetic.Star,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.Star,["numPoints","innerRadius","outerRadius"]);Kinetic.RegularPolygon=function(a){this._initRegularPolygon(a)};Kinetic.RegularPolygon.prototype={_initRegularPolygon:function(a){this.setDefaultAttrs({radius:0,sides:0});this.shapeType="RegularPolygon";Kinetic.Shape.call(this,a);this._setDrawFuncs()},drawFunc:function(a){a.beginPath();a.moveTo(0,0-this.attrs.radius);for(var b=1;b<this.attrs.sides;b++){var d=this.attrs.radius*Math.sin(2*b*Math.PI/this.attrs.sides),c=-1*this.attrs.radius*Math.cos(2*b*Math.PI/this.attrs.sides);a.lineTo(d,c)}a.closePath();this.fillStroke(a)}};Kinetic.Global.extend(Kinetic.RegularPolygon,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.RegularPolygon,["radius","sides"]);Kinetic.Path=function(a){this._initPath(a)};Kinetic.Path.prototype={_initPath:function(a){this.shapeType="Path";this.dataArray=[];var b=this;Kinetic.Shape.call(this,a);this._setDrawFuncs();this.dataArray=Kinetic.Path.parsePathData(this.attrs.data);this.on("dataChange",function(){b.dataArray=Kinetic.Path.parsePathData(b.attrs.data)})},drawFunc:function(a){var b=this.dataArray;a.beginPath();for(var d=0;d<b.length;d++){var c=b[d].points;switch(b[d].command){case"L":a.lineTo(c[0],c[1]);break;case"M":a.moveTo(c[0],c[1]);break;case"C":a.bezierCurveTo(c[0],c[1],c[2],c[3],c[4],c[5]);break;case"Q":a.quadraticCurveTo(c[0],c[1],c[2],c[3]);break;case"A":var e=c[0],f=c[1],g=c[2],j=c[3],l=c[4],m=c[5],k=c[6],c=c[7],n=g>j?g:j,p=g>j?1:g/j,g=g>j?j/g:1;a.translate(e,f);a.rotate(k);a.scale(p,g);a.arc(0,0,n,l,l+m,1-c);a.scale(1/p,1/g);a.rotate(-k);a.translate(-e,-f);break;case"z":a.closePath()}}this.fillStroke(a)}};Kinetic.Global.extend(Kinetic.Path,Kinetic.Shape);Kinetic.Path.getLineLength=function(a,b,d,c){return Math.sqrt((d-a)*(d-a)+(c-b)*(c-b))};Kinetic.Path.getPointOnLine=function(a,b,d,c,e,f,g){void 0===f&&(f=b);void 0===g&&(g=d);var j=(e-d)/(c-b+1E-8),l=Math.sqrt(a*a/(1+j*j));c<b&&(l*=-1);var m=j*l;if((g-d)/(f-b+1E-8)===j)b={x:f+l,y:g+m};else{m=this.getLineLength(b,d,c,e);if(1E-8>m)return;l=((f-b)*(c-b)+(g-d)*(e-d))/(m*m);m=b+l*(c-b);d+=l*(e-d);f=this.getLineLength(f,g,m,d);a=Math.sqrt(a*a-f*f);l=Math.sqrt(a*a/(1+j*j));c<b&&(l*=-1);b={x:m+l,y:d+j*l}}return b};Kinetic.Path.getPointOnCubicBezier=function(a,b,d,c,e,f,g,j,l){return{x:j*a*a*a+f*3*a*a*(1-a)+c*3*a*(1-a)*(1-a)+b*(1-a)*(1-a)*(1-a),y:l*a*a*a+g*3*a*a*(1-a)+e*3*a*(1-a)*(1-a)+d*(1-a)*(1-a)*(1-a)}};Kinetic.Path.getPointOnQuadraticBezier=function(a,b,d,c,e,f,g){return{x:f*a*a+c*2*a*(1-a)+b*(1-a)*(1-a),y:g*a*a+e*2*a*(1-a)+d*(1-a)*(1-a)}};Kinetic.Path.getPointOnEllipticalArc=function(a,b,d,c,e,f){var g=Math.cos(f);f=Math.sin(f);d*=Math.cos(e);c*=Math.sin(e);return{x:a+(d*g-c*f),y:b+(d*f+c*g)}};Kinetic.Path.parsePathData=function(a){if(!a)return[];var b,d="mMlLvVhHzZcCqQtTsSaA".split("");b=a.replace(RegExp(" ","g"),",");for(a=0;a<d.length;a++)b=b.replace(RegExp(d[a],"g"),"|"+d[a]);d=b.split("|");b=[];var c=0,e=0;for(a=1;a<d.length;a++){var f=d[a],g=f.charAt(0),f=f.slice(1),f=f.replace(RegExp(",-","g"),"-"),f=f.replace(RegExp("-","g"),",-"),f=f.replace(RegExp("e,-","g"),"e-"),f=f.split(",");0<f.length&&""===f[0]&&f.shift();for(var j=0;j<f.length;j++)f[j]=parseFloat(f[j]);for(;0<f.length&&!isNaN(f[0]);){var l=null,m=[],j=c,k=e;switch(g){case"l":c+=f.shift();e+=f.shift();l="L";m.push(c,e);break;case"L":c=f.shift();e=f.shift();m.push(c,e);break;case"m":c+=f.shift();e+=f.shift();l="M";m.push(c,e);g="l";break;case"M":c=f.shift();e=f.shift();l="M";m.push(c,e);g="L";break;case"h":c+=f.shift();l="L";m.push(c,e);break;case"H":c=f.shift();l="L";m.push(c,e);break;case"v":e+=f.shift();l="L";m.push(c,e);break;case"V":e=f.shift();l="L";m.push(c,e);break;case"C":m.push(f.shift(),f.shift(),f.shift(),f.shift());c=f.shift();e=f.shift();m.push(c,e);break;case"c":m.push(c+f.shift(),e+f.shift(),c+f.shift(),e+f.shift());c+=f.shift();e+=f.shift();l="C";m.push(c,e);break;case"S":var n=c,p=e,l=b[b.length-1];"C"===l.command&&(n=c+(c-l.points[2]),p=e+(e-l.points[3]));m.push(n,p,f.shift(),f.shift());c=f.shift();e=f.shift();l="C";m.push(c,e);break;case"s":n=c;p=e;l=b[b.length-1];"C"===l.command&&(n=c+(c-l.points[2]),p=e+(e-l.points[3]));m.push(n,p,c+f.shift(),e+f.shift());c+=f.shift();e+=f.shift();l="C";m.push(c,e);break;case"Q":m.push(f.shift(),f.shift());c=f.shift();e=f.shift();m.push(c,e);break;case"q":m.push(c+f.shift(),e+f.shift());c+=f.shift();e+=f.shift();l="Q";m.push(c,e);break;case"T":n=c;p=e;l=b[b.length-1];"Q"===l.command&&(n=c+(c-l.points[0]),p=e+(e-l.points[1]));c=f.shift();e=f.shift();l="Q";m.push(n,p,c,e);break;case"t":n=c;p=e;l=b[b.length-1];"Q"===l.command&&(n=c+(c-l.points[0]),p=e+(e-l.points[1]));c+=f.shift();e+=f.shift();l="Q";m.push(n,p,c,e);break;case"A":var m=f.shift(),n=f.shift(),p=f.shift(),r=f.shift(),q=f.shift(),s=c,v=e,c=f.shift(),e=f.shift(),l="A",m=this.convertEndpointToCenterParameterization(s,v,c,e,r,q,m,n,p);break;case"a":m=f.shift(),n=f.shift(),p=f.shift(),r=f.shift(),q=f.shift(),s=c,v=e,c+=f.shift(),e+=f.shift(),l="A",m=this.convertEndpointToCenterParameterization(s,v,c,e,r,q,m,n,p)}b.push({command:l||g,points:m,start:{x:j,y:k},pathLength:this.calcLength(j,k,l||g,m)})}("z"===g||"Z"===g)&&b.push({command:"z",points:[],start:void 0,pathLength:0})}return b};Kinetic.Path.calcLength=function(a,b,d,c){var e,f,g=Kinetic.Path;switch(d){case"L":return g.getLineLength(a,b,c[0],c[1]);case"C":d=0;e=g.getPointOnCubicBezier(0,a,b,c[0],c[1],c[2],c[3],c[4],c[5]);for(t=0.01;1>=t;t+=0.01)f=g.getPointOnCubicBezier(t,a,b,c[0],c[1],c[2],c[3],c[4],c[5]),d+=g.getLineLength(e.x,e.y,f.x,f.y),e=f;return d;case"Q":d=0;e=g.getPointOnQuadraticBezier(0,a,b,c[0],c[1],c[2],c[3]);for(t=0.01;1>=t;t+=0.01)f=g.getPointOnQuadraticBezier(t,a,b,c[0],c[1],c[2],c[3]),d+=g.getLineLength(e.x,e.y,f.x,f.y),e=f;return d;case"A":d=0;f=c[4];var j=c[5];a=c[4]+j;b=Math.PI/180;Math.abs(f-a)<b&&(b=Math.abs(f-a));e=g.getPointOnEllipticalArc(c[0],c[1],c[2],c[3],f,0);if(0>j)for(t=f-b;t>a;t-=b)f=g.getPointOnEllipticalArc(c[0],c[1],c[2],c[3],t,0),d+=g.getLineLength(e.x,e.y,f.x,f.y),e=f;else for(t=f+b;t<a;t+=b)f=g.getPointOnEllipticalArc(c[0],c[1],c[2],c[3],t,0),d+=g.getLineLength(e.x,e.y,f.x,f.y),e=f;f=g.getPointOnEllipticalArc(c[0],c[1],c[2],c[3],a,0);return d+=g.getLineLength(e.x,e.y,f.x,f.y)}return 0};Kinetic.Path.convertEndpointToCenterParameterization=function(a,b,d,c,e,f,g,j,l){l*=Math.PI/180;var m=Math.cos(l)*(a-d)/2+Math.sin(l)*(b-c)/2,k=-1*Math.sin(l)*(a-d)/2+Math.cos(l)*(b-c)/2,n=m*m/(g*g)+k*k/(j*j);1<n&&(g*=Math.sqrt(n),j*=Math.sqrt(n));n=Math.sqrt((g*g*j*j-g*g*k*k-j*j*m*m)/(g*g*k*k+j*j*m*m));e==f&&(n*=-1);isNaN(n)&&(n=0);e=n*g*k/j;n=n*-j*m/g;a=(a+d)/2+Math.cos(l)*e-Math.sin(l)*n;b=(b+c)/2+Math.sin(l)*e+Math.cos(l)*n;var p=function(a,b){return(a[0]*b[0]+a[1]*b[1])/(Math.sqrt(a[0]*a[0]+a[1]*a[1])*Math.sqrt(b[0]*b[0]+b[1]*b[1]))},r=function(a,b){return(a[0]*b[1]<a[1]*b[0]?-1:1)*Math.acos(p(a,b))};c=r([1,0],[(m-e)/g,(k-n)/j]);d=[(m-e)/g,(k-n)/j];m=[(-1*m-e)/g,(-1*k-n)/j];k=r(d,m);-1>=p(d,m)&&(k=Math.PI);1<=p(d,m)&&(k=0);0===f&&0<k&&(k-=2*Math.PI);1==f&&0>k&&(k+=2*Math.PI);return[a,b,g,j,c,k,l,f]};Kinetic.Node.addGettersSetters(Kinetic.Path,["data"]);Kinetic.TextPath=function(a){this._initTextPath(a)};Kinetic.TextPath.prototype={_initTextPath:function(a){this.setDefaultAttrs({fontFamily:"Calibri",fontSize:12,fontStyle:"normal",detectionType:"path",text:""});this.dummyCanvas=document.createElement("canvas");this.shapeType="TextPath";this.dataArray=[];var b=this;Kinetic.Shape.call(this,a);this._setDrawFuncs();this.dataArray=Kinetic.Path.parsePathData(this.attrs.data);this.on("dataChange",function(){b.dataArray=Kinetic.Path.parsePathData(this.attrs.data)});a=["text","textStroke","textStrokeWidth"];for(var d=0;d<a.length;d++)this.on(a[d]+"Change",b._setTextData);b._setTextData()},drawFunc:function(a){a.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;a.textBaseline="middle";a.textAlign="left";a.save();for(var b=this.glyphInfo,d=this.appliedShadow,c=0;c<b.length;c++){this.appliedShadow=d;a.save();var e=b[c].p0;parseFloat(this.attrs.fontSize);a.translate(e.x,e.y);a.rotate(b[c].rotation);this.fillStrokeText(a,b[c].text);a.restore()}a.restore()},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},setText:function(a){Kinetic.Text.prototype.setText.call(this,a)},_getTextSize:function(a){var b=this.dummyCanvas.getContext("2d");b.save();b.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;a=b.measureText(a);b.restore();return{width:a.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var a=this._getTextSize(this.attrs.text);this.textWidth=a.width;this.textHeight=a.height;this.glyphInfo=[];for(var a=this.attrs.text.split(""),b,d,c,e=-1,f=0,g=0;g<a.length;g++){a:{var j=this._getTextSize(a[g]).width,l=0,m=0;for(d=void 0;0.01<Math.abs(j-l)/j&&25>m;){m++;for(var k=l;void 0===c;){b:{f=0;c=this.dataArray;for(var n=e+1;n<c.length;n++){if(0<c[n].pathLength){e=n;c=c[n];break b}"M"==c[n].command&&(b={x:c[n].points[0],y:c[n].points[1]})}c={}}c&&k+c.pathLength<j&&(k+=c.pathLength,c=void 0)}if(c==={}||void 0===b)break a;k=!1;switch(c.command){case"L":Kinetic.Path.getLineLength(b.x,b.y,c.points[0],c.points[1])>j?d=Kinetic.Path.getPointOnLine(j,b.x,b.y,c.points[0],c.points[1],b.x,b.y):c=void 0;break;case"A":d=c.points[4];var n=c.points[5],p=c.points[4]+n,f=0===f?d+1E-8:j>l?f+Math.PI/180*n/Math.abs(n):f-Math.PI/360*n/Math.abs(n);Math.abs(f)>Math.abs(p)&&(f=p,k=!0);d=Kinetic.Path.getPointOnEllipticalArc(c.points[0],c.points[1],c.points[2],c.points[3],f,c.points[6]);break;case"C":f=0===f?j>c.pathLength?1E-8:j/c.pathLength:j>l?f+(j-l)/c.pathLength:f-(l-j)/c.pathLength;1<f&&(f=1,k=!0);d=Kinetic.Path.getPointOnCubicBezier(f,c.start.x,c.start.y,c.points[0],c.points[1],c.points[2],c.points[3],c.points[4],c.points[5]);break;case"Q":f=0===f?j/c.pathLength:j>l?f+(j-l)/c.pathLength:f-(l-j)/c.pathLength,1<f&&(f=1,k=!0),d=Kinetic.Path.getPointOnQuadraticBezier(f,c.start.x,c.start.y,c.points[0],c.points[1],c.points[2],c.points[3])}void 0!==d&&(l=Kinetic.Path.getLineLength(b.x,b.y,d.x,d.y));k&&(c=void 0)}}if(void 0===b||void 0===d)break;j=Kinetic.Path.getLineLength(b.x,b.y,d.x,d.y);j=Kinetic.Path.getPointOnLine(0+j/2,b.x,b.y,d.x,d.y);l=Math.atan2(d.y-b.y,d.x-b.x);this.glyphInfo.push({transposeX:j.x,transposeY:j.y,text:a[g],rotation:l,p0:b,p1:d});b=d}}};Kinetic.Global.extend(Kinetic.TextPath,Kinetic.Shape);Kinetic.Node.addGettersSetters(Kinetic.TextPath,"fontFamily fontSize fontStyle textFill textStroke textStrokeWidth".split(" "));Kinetic.Node.addGetters(Kinetic.TextPath,["text","textShadow"]);Kinetic.TextPath.prototype.setTextShadow=Kinetic.Text.prototype.setTextShadow;Kinetic.TextPath.prototype.fillText=Kinetic.Text.prototype.fillText;Kinetic.TextPath.prototype.strokeText=Kinetic.Text.prototype.strokeText;Kinetic.TextPath.prototype.fillStrokeText=Kinetic.Text.prototype.strokeText;var stage=new Kinetic.Stage({container:"container",width:500,height:400}),activeLayer=!1,globalError=0,count=0,rectX=stage.getWidth()/2-50,rectY=stage.getHeight()/2-25,borderX=20,borderY=20,w=stage.getWidth()-2*borderX,h=stage.getHeight()-2*borderY;function createBox(a,b,d){return new Kinetic.Rect({x:b-10,y:d-10,width:20,height:20,cornerRadius:a,fill:"transparent",stroke:"white",strokeWidth:2,draggable:!0,id:"driverBox"})}
function getArrow(a,b,d,c,e,f){var g=[];if(b<c){var j=180*Math.atan(Math.abs(a-d)/Math.abs(b-c))/3.14;c=3.14*(j-e)/180;e=3.14*(j+e)/180;a>d?g.push(a-f*Math.sin(c),b+f*Math.cos(c),a-f*Math.sin(e),b+f*Math.cos(e)):g.push(a+f*Math.sin(c),b+f*Math.cos(c),a+f*Math.sin(e),b+f*Math.cos(e))}else b==c?(e=3.14*e/180,a>d?g.push(a-f*Math.cos(e),b+f*Math.sin(e),a-f*Math.cos(e),b-f*Math.sin(e)):g.push(a+f*Math.cos(e),b+f*Math.sin(e),a+f*Math.cos(e),b-f*Math.sin(e))):a>d?(j=180*Math.atan(Math.abs(b-c)/Math.abs(a-d))/3.14,c=3.14*(j-e)/180,e=3.14*(j+e)/180,g.push(a-f*Math.cos(c),b-f*Math.sin(c),a-f*Math.cos(e),b-f*Math.sin(e))):a==d?(e=3.14*e/180,g.push(a-f*Math.sin(e),b-f*Math.cos(e),a+f*Math.sin(e),b-f*Math.cos(e))):(j=180*Math.atan(Math.abs(b-c)/Math.abs(a-d))/3.14,c=3.14*(j-e)/180,e=3.14*(j+e)/180,g.push(a+f*Math.cos(c),b-f*Math.sin(c),a+f*Math.cos(e),b-f*Math.sin(e)));return g}
function showError(a){var b=Math.floor(a);a=""+Math.floor(1E3*(a-b)+0.5);2==a.length?a="0"+a:1==a.length&&(a="00"+a);"0"==a[0]&&("0"==a[1]&&"0"==a[2])&&(a="0");jQuery("#accuracy .one").odoTicker({number:b});jQuery("#accuracy .two").odoTicker({number:a})}function setScore(a,b){jQuery("#score-board li:eq("+a+")").html(b);count+=1;jQuery("#avg-error").html((globalError/count+5E-5).toFixed(3))}
function setHeader(a,b,d){d="undefined"==typeof d?!1:d;jQuery(".tiptip").html(a);jQuery(".tiptip").tipTip({defaultPosition:"bottom",keepAlive:d,content:b});a=290-jQuery(".tiptip").width()/2;jQuery(".unselectable").css({left:a})}
function registerDriverAnimation(a,b){jQuery("#container").mousedown(function(d){a.isVisible()&&a.setDraggable(!0);var c=d.pageX-this.offsetLeft-40,e=d.pageY-this.offsetTop-40;d=a.getPosition().x;var f=a.getPosition().y,g=a.getWidth(),j=a.getHeight();if(a.isVisible()&&0<=c&&(0<=e&&500>=c&&400>=e)&&(c<d||c>d+g||e<f||e>f+j)){jQuery(".counter").counter("play");a.transitionTo({x:c-g/2,y:e-j/2,duration:0.2,easing:"ease-in",callback:function(){if("line"in b)for(var d=0;d<b.line.length;d++){var f=b.line[d].getPoints();b.line[d].setPoints([f[0].x,f[0].y,c,e])}if("arrow"in b)for(d=0;d<b.arrow.length;d++){var f=b.arrow[d][0].getPoints(),g=getArrow(c,e,f[0].x,f[0].y,15,Math.sqrt((c-f[0].x)*(c-f[0].x)+(e-f[0].y)*(e-f[0].y))/10);b.arrow[d][0].setPoints([f[0].x,f[0].y,c,e]);b.arrow[d][1].setPoints([g[0],g[1],c,e]);b.arrow[d][2].setPoints([g[2],g[3],c,e])}a.simulate("mousedown")}});if("circle"in b)for(d=0;d<b.circle.length;d++)b.circle[d].transitionTo({x:c,y:e,duration:0.2,easing:"ease-in"});if("marker"in b)for(d=0;d<b.marker.length;d++)f=Math.abs(b.marker[d][0].getPoints()[0].x-b.marker[d][0].getPoints()[1].x),b.marker[d][0].setPoints([c-f/2,e,c+f/2,e]),b.marker[d][1].setPoints([c,e-f/2,c,e+f/2])}else a.isVisible()&&(c>=d&&c<=d+g&&e>=f&&e<=f+j)&&(a.simulate("mousedown"),a.setDraggable(!0))});jQuery(document).mouseup(function(b){var c=b.pageX-jQuery("#container").offset().left-40;b=b.pageY-jQuery("#container").offset().top-40;var e=jQuery("#container").width(),f=jQuery("#container").height();if(0>=c||c>=e||0>=b||b>=f)a.isDragging()&&(a.simulate("dragend"),a.setDraggable(!1));else{var e=a.getPosition().x,f=a.getPosition().y,g=a.getWidth(),j=a.getHeight();(c<e||c>e+g||b<f||b>f+j)&&a.setDraggable(!1)}})};var rectFrame=function(a){var b=Math.floor(Math.random()*w+borderX),d=Math.floor(Math.random()*h+borderY),c=Math.floor(Math.random()*(w/2-borderX+1)+borderX),e=Math.floor(Math.random()*(h/4+1)+borderY+h/4),f=Math.floor(Math.random()*(w/2-borderX+1)+borderX),g=Math.floor(Math.random()*(h/4+1)+borderY+h/2),j=w/2+f-borderX,l=0;if(0>f-c)l=Math.floor(Math.random()*(h/2+1)+borderY+h/2);else{for(var m=Math.tan(Math.atan((g-e)/(f-c))-Math.PI/6)*(j-c)+e;m<h/2;)f=Math.floor(Math.random()*(w/2-borderX+1)+borderX),g=Math.floor(Math.random()*(h/4+1)+borderY+h/2),j=w/2+f-borderX,m=Math.tan(Math.atan((g-e)/(f-c))-Math.PI/6)*(j-c)+e;l=m<h?Math.floor(Math.random()*(m-h/2)+borderY+h/2):Math.floor(Math.random()*(h/2+1)+borderY+h/2)}var m=(l-g)/(j-f),k=(g-e)/(f-c),n=(l-e+c*m-j*k)/(m-k),p=m*(n-c)+e;activeLayer=m=new Kinetic.Layer;var r=createBox(6,b,d),k=new Kinetic.Shape({drawFunc:function(a){a.beginPath();a.moveTo(c,e);a.lineTo(f,g);a.lineTo(j,l);this.fillStroke(a)},stroke:"white",strokeWidth:2}),q=new Kinetic.Line({points:[c,e,b,d],stroke:"red",strokeWidth:0.6,lineCap:"round",lineJoin:"round"}),s=new Kinetic.Line({points:[j,l,b,d],stroke:"red",strokeWidth:0.6,lineCap:"round",lineJoin:"round"}),v=new Kinetic.Line({points:[c,e,n,p],stroke:"green",strokeWidth:1,lineCap:"round",lineJoin:"round"}),x=new Kinetic.Line({points:[j,l,n,p],stroke:"green",strokeWidth:1,lineCap:"round",lineJoin:"round"});v.hide();x.hide();r.on("mouseover",function(){document.body.style.cursor="pointer";r.setFill("black");r.setOpacity(0.4);stage.draw()});r.on("mouseout",function(){document.body.style.cursor="default";r.setFill("transparent");r.setOpacity(1);stage.draw()});r.on("dragstart",function(){jQuery(".counter").counter("play")});r.on("dragmove",function(){q.setPoints([c,e,r.getPosition().x+r.getWidth()/2,r.getPosition().y+r.getHeight()/2]);s.setPoints([j,l,r.getPosition().x+r.getWidth()/2,r.getPosition().y+r.getHeight()/2])});r.on("dragend",function(){jQuery(".counter").counter("stop");v.show();x.show();r.hide();stage.draw();var b=r.getPosition().x+r.getWidth()/2,c=r.getPosition().y+r.getHeight()/2,b=Math.sqrt((n-b)*(n-b)+(p-c)*(p-c));globalError=parseFloat(globalError)+parseFloat(b);b=(b+5E-4).toFixed(3);showError(b);setScore(a,b);jQuery(".clickable").show("explode",{pieces:8},1400)});m.add(k);m.add(q);m.add(s);m.add(v);m.add(x);m.add(r);stage.add(m);setHeader("Parallelogram","<span>Drag the small semi-rectangular shape along the board in order to make the <a style='color: yellow' href='http://en.wikipedia.org/wiki/Quadrilateral' target='_blank'>quadrilateral</a> a <a style='color: yellow' href='http://en.wikipedia.org/wiki/Parallelogram'  target='_blank'>parallelogram</a></span>",!0);registerDriverAnimation(stage.get("#driverBox")[0],{line:[q,s]})};var circleFrame=function(a){var b=Math.floor(Math.random()*w+borderX),d=Math.floor(Math.random()*h+borderY),c=Math.floor(Math.random()*(h/2-80)+80),e=Math.floor(Math.random()*(w-2*c)+borderX+c),f=Math.floor(Math.random()*(h-2*c)+borderY+c),g=new Kinetic.Layer;activeLayer=g;var j=new Kinetic.Circle({x:e,y:f,radius:c,fill:"transparent",stroke:"white",strokeWidth:2});new Kinetic.Line({points:[e-6,f,e+6,f],stroke:"green",strokeWidth:1});var l=new Kinetic.Circle({x:e,y:f,radius:3,fill:"transparent",stroke:"green",strokeWidth:1});l.hide();var m=new Kinetic.Circle({x:e,y:f,radius:3,fill:"transparent",stroke:"red",strokeWidth:0.6});m.hide();var k=createBox(10,b,d);k.setDragBoundFunc(function(a){var b=j.getPosition().x-10,c=j.getPosition().y-10,d=(j.getRadius()-10)/Math.sqrt((a.x-b)*(a.x-b)+(a.y-c)*(a.y-c));return 1>d?{y:Math.round((a.y-c)*d+c),x:Math.round((a.x-b)*d+b)}:a});var n=new Kinetic.Line({points:[b-6,d,b+6,d],stroke:"red",strokeWidth:0.6}),p=new Kinetic.Line({points:[b,d-6,b,d+6],stroke:"red",strokeWidth:0.6});k.on("mouseover",function(){document.body.style.cursor="pointer";k.setFill("black");k.setOpacity(0.4);stage.draw()});k.on("mouseout",function(){document.body.style.cursor="default";k.setFill("transparent");k.setOpacity(1);stage.draw()});k.on("dragstart",function(){jQuery(".counter").counter("play")});k.on("dragmove",function(){n.setPoints([k.getPosition().x+k.getWidth()/2-6,k.getPosition().y+k.getHeight()/2,k.getPosition().x+k.getWidth()/2+6,k.getPosition().y+k.getHeight()/2]);p.setPoints([k.getPosition().x+k.getWidth()/2,k.getPosition().y+k.getHeight()/2-6,k.getPosition().x+k.getWidth()/2,k.getPosition().y+k.getHeight()/2+6])});k.on("dragend",function(){jQuery(".counter").counter("stop");m.setPosition(k.getPosition().x+k.getWidth()/2,k.getPosition().y+k.getHeight()/2);n.hide();p.hide();l.show();m.show();k.hide();k.setDraggable(!1);stage.draw();var b=k.getPosition().x+k.getWidth()/2,c=k.getPosition().y+k.getHeight()/2,b=Math.sqrt((e-b)*(e-b)+(f-c)*(f-c));globalError=parseFloat(globalError)+parseFloat(b);b=(b+5E-4).toFixed(3);showError(b);setScore(a,b);jQuery(".clickable").show("explode",{pieces:8},1400)});g.add(j);g.add(k);g.add(m);g.add(l);g.add(n);g.add(p);stage.add(g);setHeader("Center of a Circle","<span>Drag the small circular shape along the board in order to make the <span style='color: red'>red</span> cross coincide with the <b>center</b> of the larger <b>white circle</b></span>");registerDriverAnimation(stage.get("#driverBox")[0],{marker:[[n,p]]})};var bisectFrame=function(a){var b=Math.floor(Math.random()*w+borderX),d=Math.floor(Math.random()*h+borderY),c=Math.floor(Math.random()*(w/4-10)+borderX),e=Math.floor(Math.random()*h/4+borderY),f=Math.floor(Math.random()*(w/4-10)+borderX+0.75*w+10),g=Math.floor(Math.random()*h/4+borderY),j=Math.floor(Math.random()*(w/2-20)+borderX+w/4+10),l=Math.floor(Math.random()*h/4+borderY+0.75*h),m=180*Math.atan((l-e)/(j-c))/Math.PI,k=180*Math.atan((l-g)/(f-j))/Math.PI,n=m+(180-m-k)/2,m=Math.tan(n*Math.PI/180),p=l-250,r=j-250/m,q=getArrow(c,e,j,l,20,Math.sqrt((c-j)*(c-j)+(e-l)*(e-l))/10),s=getArrow(f,g,j,l,20,Math.sqrt((f-j)*(f-j)+(g-l)*(g-l))/10),v=getArrow(r,p,j,l,15,Math.sqrt((r-j)*(r-j)+(p-l)*(p-l))/10),x=getArrow(b,d,j,l,15,Math.sqrt((b-j)*(b-j)+(d-l)*(d-l))/10);activeLayer=m=new Kinetic.Layer;var u=createBox(6,b,d),k=new Kinetic.Shape({drawFunc:function(a){a.beginPath();a.moveTo(c,e);a.lineTo(j,l);a.lineTo(f,g);a.moveTo(q[0],q[1]);a.lineTo(c,e);a.lineTo(q[2],q[3]);a.moveTo(s[0],s[1]);a.lineTo(f,g);a.lineTo(s[2],s[3]);this.fillStroke(a)},stroke:"white",strokeWidth:2,lineCap:"round",lineJoin:"round"}),A=new Kinetic.Line({points:[j,l,b,d],stroke:"red",strokeWidth:1,lineCap:"round",lineJoin:"round"}),y=new Kinetic.Line({points:[b,d,x[0],x[1]],stroke:"red",strokeWidth:1,lineCap:"round",lineJoin:"round"}),z=new Kinetic.Line({points:[b,d,x[2],x[3]],stroke:"red",strokeWidth:1,lineCap:"round",lineJoin:"round"}),B=new Kinetic.Shape({drawFunc:function(a){a.beginPath();a.moveTo(j,l);a.lineTo(r,p);a.moveTo(v[0],v[1]);a.lineTo(r,p);a.lineTo(v[2],v[3]);this.fillStroke(a)},stroke:"green",strokeWidth:1});B.hide();u.on("mouseover",function(){document.body.style.cursor="pointer";u.setFill("black");u.setOpacity(0.4);stage.draw()});u.on("mouseout",function(){document.body.style.cursor="default";u.setFill("transparent");u.setOpacity(1);stage.draw()});u.on("dragstart",function(){jQuery(".counter").counter("play")});u.on("dragmove",function(){var a=u.getPosition().x+u.getWidth()/2,b=u.getPosition().y+u.getHeight()/2;A.setPoints([j,l,a,b]);x=getArrow(a,b,j,l,15,Math.sqrt((a-j)*(a-j)+(b-l)*(b-l))/10);y.setPoints([x[0],x[1],a,b]);z.setPoints([x[2],x[3],a,b])});u.on("dragend",function(){jQuery(".counter").counter("stop");B.show();u.hide();stage.draw();var b=u.getPosition().x+u.getWidth()/2,c=u.getPosition().y+u.getHeight()/2,c=180*Math.atan((l-c)/(j-b))/Math.PI,b=Math.abs(2*(b<j?n-c:180+c-n));globalError=parseFloat(globalError)+parseFloat(b);b=(b+5E-4).toFixed(3);showError(b);setScore(a,b);jQuery(".clickable").show("explode",{pieces:8},1400)});m.add(A);m.add(y);m.add(z);m.add(B);m.add(k);m.add(u);stage.add(m);setHeader("Angle Bisection","<span>Drag the small semi-rectangular shape along the board to place the <span style='color: red'>red</span> line along the <b>angular bisector</b> of the <strong>white</strong> lines</span>");registerDriverAnimation(stage.get("#driverBox")[0],{arrow:[[A,y,z]]})};var midPointFrame=function(a){var b=Math.floor(Math.random()*w+borderX),d=Math.floor(Math.random()*h+borderY),c=Math.floor(Math.random()*w+borderX),e=Math.floor(Math.random()*h/4+borderY),f=Math.floor(Math.random()*w+borderX),g=Math.floor(Math.random()*h/4+borderY+0.75*h),j=Math.min(c,f)+Math.abs(f-c)/2,l=Math.min(e,g)+Math.abs(g-e)/2,m=new Kinetic.Layer;activeLayer=m;var k=createBox(6,b,d),n=new Kinetic.Shape({drawFunc:function(a){a.beginPath();a.moveTo(c-10,e);a.lineTo(c+10,e);a.moveTo(c,e-10);a.lineTo(c,e+10);a.moveTo(f-10,g);a.lineTo(f+10,g);a.moveTo(f,g-10);a.lineTo(f,g+10);this.fillStroke(a)},stroke:"white",strokeWidth:2}),p=new Kinetic.Circle({x:c,y:e,radius:3,fill:"white"}),r=new Kinetic.Circle({x:f,y:g,radius:3,fill:"white"}),q=new Kinetic.Line({points:[c,e,b,d],stroke:"red",strokeWidth:0.6,lineCap:"round",lineJoin:"round"}),s=new Kinetic.Line({points:[f,g,b,d],stroke:"red",strokeWidth:0.6,lineCap:"round",lineJoin:"round"}),v=new Kinetic.Circle({x:b,y:d,radius:3,fill:"black",stroke:"red",strokeWidth:0.6}),x=new Kinetic.Line({points:[c,e,f,g],stroke:"green",strokeWidth:1,lineCap:"round"}),u=new Kinetic.Circle({x:j,y:l,radius:3,fill:"transparent",stroke:"green",strokeWidth:1});x.hide();u.hide();k.on("mouseover",function(){document.body.style.cursor="pointer";k.setFill("black");k.setOpacity(0.4);stage.draw()});k.on("mouseout",function(){document.body.style.cursor="default";k.setFill("transparent");k.setOpacity(1);stage.draw()});k.on("dragstart",function(){jQuery(".counter").counter("play")});k.on("dragmove",function(){q.setPoints([c,e,k.getPosition().x+k.getWidth()/2,k.getPosition().y+k.getHeight()/2]);s.setPoints([f,g,k.getPosition().x+k.getWidth()/2,k.getPosition().y+k.getHeight()/2]);v.setPosition(k.getPosition().x+k.getWidth()/2,k.getPosition().y+k.getHeight()/2)});k.on("dragend",function(){jQuery(".counter").counter("stop");v.setFill("transparent");k.hide();x.show();u.show();stage.draw();var b=k.getPosition().x+k.getWidth()/2,c=k.getPosition().y+k.getHeight()/2,b=Math.sqrt((j-b)*(j-b)+(l-c)*(l-c));globalError=parseFloat(globalError)+parseFloat(b);b=(b+5E-4).toFixed(3);showError(b);setScore(a,b);jQuery(".clickable").show("explode",{pieces:8},1400)});m.add(n);m.add(q);m.add(s);m.add(x);m.add(v);m.add(u);m.add(p);m.add(r);m.add(k);stage.add(m);setHeader("Mid Point","<span>Drag the small semi-rectangular shape along the board in order to make the <span style='color: black; background: white'>black</span> point coincide with the <b>mid point</b> of the line segment joining the <b>white crossbars</b></span>");registerDriverAnimation(stage.get("#driverBox")[0],{line:[q,s],circle:[v]})};var convergeFrame=function(a){var b=Math.floor(Math.random()*w+borderX),d=Math.floor(Math.random()*h+borderY),c=Math.floor(Math.random()*w/6+borderX+5*w/12),e=Math.floor(Math.random()*h/6+borderY+5*h/12),f=Math.floor(Math.random()*w/3+borderX),g=borderY,j=borderX+w,l=Math.floor(Math.random()*h/3+borderY),m=Math.floor(Math.random()*w+borderX),k=borderY+h,n=f+h*(c-f)/(4*(e-g)),p=borderY+h/4,r=borderX+0.75*w,q=e-(0.75*w+borderX-c)*(e-l)/(j-c),s=c+(m<c?-1:1)*((0.75*h+borderY-e)*Math.abs(c-m)/(k-e)),v=borderY+0.75*h,x=getArrow(n,p,f,g,20,Math.sqrt((n-f)*(n-f)+(p-g)*(p-g))/6),u=getArrow(r,q,j,l,20,Math.sqrt((r-j)*(r-j)+(q-l)*(q-l))/6),A=getArrow(s,v,m,k,20,Math.sqrt((s-m)*(s-m)+(v-k)*(v-k))/6),y=new Kinetic.Layer;activeLayer=y;var z=createBox(6,b,d),B=new Kinetic.Shape({drawFunc:function(a){a.beginPath();a.moveTo(f,g);a.lineTo(n,p);a.moveTo(j,l);a.lineTo(r,q);a.moveTo(m,k);a.lineTo(s,v);a.moveTo(x[0],x[1]);a.lineTo(n,p);a.lineTo(x[2],x[3]);a.moveTo(u[0],u[1]);a.lineTo(r,q);a.lineTo(u[2],u[3]);a.moveTo(A[0],A[1]);a.lineTo(s,v);a.lineTo(A[2],A[3]);a.moveTo(f-10,g);a.lineTo(f+10,g);a.moveTo(f,g-10);a.lineTo(f,g+10);a.moveTo(j-10,l);a.lineTo(j+10,l);a.moveTo(j,l-10);a.lineTo(j,l+10);a.moveTo(m-10,k);a.lineTo(m+10,k);a.moveTo(m,k-10);a.lineTo(m,k+10);this.fillStroke(a)},stroke:"white",strokeWidth:2,lineCap:"round",lineJoin:"bevel"}),I=new Kinetic.Shape({drawFunc:function(a){a.beginPath();a.moveTo(f-10,g);a.lineTo(f+10,g);a.moveTo(f,g-10);a.lineTo(f,g+10);a.moveTo(j-10,l);a.lineTo(j+10,l);a.moveTo(j,l-10);a.lineTo(j,l+10);a.moveTo(m-10,k);a.lineTo(m+10,k);a.moveTo(m,k-10);a.lineTo(m,k+10);this.fillStroke(a)},stroke:"#1A40E3",strokeWidth:2,lineCap:"round"}),J=new Kinetic.Circle({x:f,y:g,radius:3,fill:"#1A40E3"}),K=new Kinetic.Circle({x:j,y:l,radius:3,fill:"#1A40E3"}),L=new Kinetic.Circle({x:m,y:k,radius:3,fill:"#1A40E3"}),C=new Kinetic.Line({points:[n,p,b,d],stroke:"red",strokeWidth:0.6,lineCap:"round",lineJoin:"round"}),D=new Kinetic.Line({points:[r,q,b,d],stroke:"red",strokeWidth:0.6,lineCap:"round",lineJoin:"round"}),E=new Kinetic.Line({points:[s,v,b,d],stroke:"red",strokeWidth:0.6,lineCap:"round",lineJoin:"round"}),F=new Kinetic.Line({points:[n,p,c,e],stroke:"green",strokeWidth:1,lineCap:"round",lineJoin:"round"}),G=new Kinetic.Line({points:[r,q,c,e],stroke:"green",strokeWidth:1,lineCap:"round",lineJoin:"round"}),H=new Kinetic.Line({points:[s,v,c,e],stroke:"green",strokeWidth:1,lineCap:"round",lineJoin:"round"});F.hide();G.hide();H.hide();z.on("mouseover",function(){document.body.style.cursor="pointer";z.setFill("black");z.setOpacity(0.4);stage.draw()});z.on("mouseout",function(){document.body.style.cursor="default";z.setFill("transparent");z.setOpacity(1);stage.draw()});z.on("dragstart",function(){jQuery(".counter").counter("play")});z.on("dragmove",function(){var a=z.getPosition().x+z.getWidth()/2,b=z.getPosition().y+z.getHeight()/2;C.setPoints([n,p,a,b]);D.setPoints([r,q,a,b]);E.setPoints([s,v,a,b])});z.on("dragend",function(){jQuery(".counter").counter("stop");F.show();G.show();H.show();z.hide();stage.draw();var b=z.getPosition().x+z.getWidth()/2,d=z.getPosition().y+z.getHeight()/2,b=Math.sqrt((c-b)*(c-b)+(e-d)*(e-d));globalError=parseFloat(globalError)+parseFloat(b);b=(b+5E-4).toFixed(3);showError(b);setScore(a,b);jQuery(".clickable").show("explode",{pieces:8},1400)});y.add(B);y.add(I);y.add(J);y.add(K);y.add(L);y.add(C);y.add(D);y.add(E);y.add(F);y.add(G);y.add(H);y.add(z);stage.add(y);setHeader("Concurrent Lines","<span>Drag the small semi-rectangular shape along with the <span style='color: red'>red</span> lines to make the <b>3 white lines <a style='color: yellow' href='http://en.wikipedia.org/wiki/Concurrent_lines' target='_blank'>concurrent</a></b></span>",!0);registerDriverAnimation(stage.get("#driverBox")[0],{line:[C,D,E]})};var diaFrame=function(a){var b=Math.floor(Math.random()*w+borderX),d=Math.floor(Math.random()*h+borderY),c=Math.floor(Math.random()*(h/2-120)+120),e=Math.floor(Math.random()*(w-2*c)+borderX+c),f=Math.floor(Math.random()*(h-2*c)+borderY+c),g=new Kinetic.Layer;activeLayer=g;var j=new Kinetic.Circle({x:e,y:f,radius:c,fill:"transparent",stroke:"white",strokeWidth:2}),l=new Kinetic.Line({points:[e-c,f,e+c,f],stroke:"green",strokeWidth:1,lineCap:"round",lineJoin:"round"}),m=f+(0.5<Math.random()?1:-1)*Math.random()*c,k=Math.sqrt(c*c-(f-m)*(f-m)),n=new Kinetic.Line({points:[e-k,m,e+k,m],stroke:"red",strokeWidth:0.6,lineCap:"round",lineJoin:"round"});l.hide();var p=createBox(6,b,d);p.setDragBoundFunc(function(a){var b=j.getPosition().x-10,c=j.getPosition().y-10,d=(j.getRadius()-10)/Math.sqrt((a.x-b)*(a.x-b)+(a.y-c)*(a.y-c));return 1>d?{y:Math.round((a.y-c)*d+c),x:Math.round((a.x-b)*d+b)}:a});p.on("mouseover",function(){document.body.style.cursor="pointer";p.setFill("black");p.setOpacity(0.4);stage.draw()});p.on("mouseout",function(){document.body.style.cursor="default";p.setFill("transparent");p.setOpacity(1);stage.draw()});p.on("dragstart",function(){jQuery(".counter").counter("play")});p.on("dragmove",function(){var a=p.getPosition().y+p.getHeight()/2,b=Math.sqrt(c*c-(f-a)*(f-a));n.setPoints([e-b,a,e+b,a])});p.on("dragend",function(){jQuery(".counter").counter("stop");l.show();p.hide();p.setDraggable(!1);stage.draw();var b=p.getPosition().y+p.getHeight()/2,b=Math.abs(f-b);globalError=parseFloat(globalError)+parseFloat(b);b=(b+5E-4).toFixed(3);showError(b);setScore(a,b);jQuery(".clickable").show("explode",{pieces:8},1400)});g.add(n);g.add(l);g.add(j);g.add(p);stage.add(g);setHeader("Diameter of a Circle","<span>Drag the small semi-rectangular shape to make the <span style='color: red'>red</span> line coincide with the <a style='color: yellow' href='http://en.wikipedia.org/wiki/Diameter' target='_blank'><b>diameter</b></a> of the <b>white circle</b></span>",!0);registerDriverAnimation(stage.get("#driverBox")[0],{})};var triFrame=function(a){var b=Math.floor(Math.random()*w+borderX),d=Math.floor(Math.random()*h+borderY),c=Math.floor(Math.random()*w/3+borderX),e=borderY,f=borderX+w,g=Math.floor(Math.random()*h/3+borderY),j=Math.floor(Math.random()*w+borderX),l=borderY+h,m=Math.sqrt((f-j)*(f-j)+(g-l)*(g-l)),k=Math.sqrt((c-j)*(c-j)+(e-l)*(e-l)),n=Math.sqrt((f-c)*(f-c)+(g-e)*(g-e)),p=(m*c+k*f+n*j)/(m+k+n),r=(m*e+k*g+n*l)/(m+k+n),m=Math.sqrt((m-k+n)*(k-n+m)*(n-m+k)*(m+k+n))/(2*(m+k+n))-1;activeLayer=k=new Kinetic.Layer;var q=createBox(6,b,d),n=new Kinetic.Shape({drawFunc:function(a){a.beginPath();a.moveTo(c,e);a.lineTo(f,g);a.lineTo(j,l);a.closePath();this.fillStroke(a)},stroke:"white",strokeWidth:2,lineJoin:"meter"}),s=new Kinetic.Circle({x:p,y:r,radius:m,fill:"transparent",stroke:"green",strokeWidth:1}),v=new Kinetic.Line({points:[c,e,b,d],stroke:"red",strokeWidth:0.6}),x=new Kinetic.Line({points:[f,g,b,d],stroke:"red",strokeWidth:0.6}),u=new Kinetic.Line({points:[j,l,b,d],stroke:"red",strokeWidth:0.6}),A=new Kinetic.Circle({x:p,y:r,radius:3,fill:"transparent",stroke:"green",strokeWidth:1}),y=new Kinetic.Circle({x:b,y:d,radius:3,fill:"black",stroke:"red",strokeWidth:0.6});s.hide();A.hide();q.on("mouseover",function(){document.body.style.cursor="pointer";q.setFill("black");q.setOpacity(0.4);stage.draw()});q.on("mouseout",function(){document.body.style.cursor="default";q.setFill("transparent");q.setOpacity(1);stage.draw()});q.on("dragstart",function(){jQuery(".counter").counter("play")});q.on("dragmove",function(){v.setPoints([c,e,q.getPosition().x+q.getWidth()/2,q.getPosition().y+q.getHeight()/2]);x.setPoints([f,g,q.getPosition().x+q.getWidth()/2,q.getPosition().y+q.getHeight()/2]);u.setPoints([j,l,q.getPosition().x+q.getWidth()/2,q.getPosition().y+q.getHeight()/2]);y.setPosition(q.getPosition().x+q.getWidth()/2,q.getPosition().y+q.getHeight()/2)});q.on("dragend",function(){jQuery(".counter").counter("stop");y.setFill("transparent");q.hide();v.hide();x.hide();u.hide();s.show();A.show();stage.draw();var b=q.getPosition().x+q.getWidth()/2,c=q.getPosition().y+q.getHeight()/2,b=Math.sqrt((p-b)*(p-b)+(r-c)*(r-c));globalError=parseFloat(globalError)+parseFloat(b);b=(b+5E-4).toFixed(3);showError(b);setScore(a,b);jQuery(".clickable").show("explode",{pieces:8},1400)});k.add(v);k.add(x);k.add(u);k.add(y);k.add(n);k.add(q);k.add(s);k.add(A);stage.add(k);setHeader("Triangle Incenter","<span>Drag the small semi-rectangular shape along the board in order to make the <span style='color: black; background: white'>black</span> point coincide with the <a style='color: yellow' href='http://mathworld.wolfram.com/Incenter.html' target='_blank'><b>incenter</b></a> of the <b>white triangle</b></span>",!0);registerDriverAnimation(stage.get("#driverBox")[0],{line:[v,x,u],circle:[y]})};var rightFrame=function(a){var b=Math.floor(Math.random()*w+borderX),d=Math.floor(Math.random()*h+borderY),c=Math.floor(Math.random()*w/4+borderX),e=Math.floor(Math.random()*h/4+h/2+borderY),f=Math.floor(Math.random()*w/4+borderX+w/2),g=Math.floor(Math.random()*h/4+borderY+0.75*h),j=getArrow(f,g,c,e,20,Math.sqrt((f-c)*(f-c)+(g-e)*(g-e))/10),l=180*Math.atan((g-e)/(f-c))/Math.PI,m=c+200*Math.sin(l*Math.PI/180),k=e-200*Math.cos(l*Math.PI/180),n=getArrow(m,k,c,e,20,Math.sqrt((m-c)*(m-c)+(k-e)*(k-e))/10),p=getArrow(b,d,c,e,20,Math.sqrt((b-c)*(b-c)+(d-e)*(d-e))/10),r=new Kinetic.Layer;activeLayer=r;var q=createBox(6,b,d);q.setDragBoundFunc(function(a){return{x:a.x,y:a.y+10>e?e-10:a.y}});var s=new Kinetic.Line({points:[c,e,f,g],stroke:"white",strokeWidth:2,lineCap:"round",lineJoin:"round"}),v=new Kinetic.Line({points:[f,g,j[0],j[1]],stroke:"white",strokeWidth:2,lineCap:"round",lineJoin:"round"}),f=new Kinetic.Line({points:[f,g,j[2],j[3]],stroke:"white",strokeWidth:2,lineCap:"round",lineJoin:"round"}),x=new Kinetic.Line({points:[c,e,b,d],stroke:"red",strokeWidth:1,lineCap:"round",lineJoin:"round"}),u=new Kinetic.Line({points:[b,d,p[0],p[1]],stroke:"red",strokeWidth:1,lineCap:"round",lineJoin:"round"}),A=new Kinetic.Line({points:[b,d,p[2],p[3]],stroke:"red",strokeWidth:1,lineCap:"round",lineJoin:"round"}),y=new Kinetic.Shape({drawFunc:function(a){a.beginPath();a.moveTo(c,e);a.lineTo(m,k);a.moveTo(n[0],n[1]);a.lineTo(m,k);a.lineTo(n[2],n[3]);this.fillStroke(a)},stroke:"green",strokeWidth:1});y.hide();q.on("mouseover",function(){document.body.style.cursor="pointer";q.setFill("black");q.setOpacity(0.4);stage.draw()});q.on("mouseout",function(){document.body.style.cursor="default";q.setFill("transparent");q.setOpacity(1);stage.draw()});q.on("dragstart",function(){jQuery(".counter").counter("play")});q.on("dragmove",function(){var a=q.getPosition().x+q.getWidth()/2,b=q.getPosition().y+q.getHeight()/2;x.setPoints([c,e,a,b]);p=getArrow(a,b,c,e,20,Math.sqrt((a-c)*(a-c)+(b-e)*(b-e))/10);u.setPoints([p[0],p[1],a,b]);A.setPoints([p[2],p[3],a,b])});q.on("dragend",function(){jQuery(".counter").counter("stop");y.show();q.hide();stage.draw();var b=q.getPosition().x+q.getWidth()/2,d=q.getPosition().y+q.getHeight()/2,f=180*Math.atan(Math.abs(e-d)/Math.abs(c-b))/Math.PI,b=2*Math.abs(b<c?90+(d<=e?-1:1)*f+l:90+(d<=e?-1:1)*f-l);globalError=parseFloat(globalError)+parseFloat(b);b=(b+5E-4).toFixed(3);showError(b);setScore(a,b);jQuery(".clickable").show("explode",{pieces:8},1400)});r.add(x);r.add(u);r.add(A);r.add(y);r.add(s);r.add(v);r.add(f);r.add(q);stage.add(r);setHeader("Right Angle","<span>Drag the small semi-rectangular shape along the board to make the <span style='color: red'>red</span> line <a style='color: yellow' href='http://en.wikipedia.org/wiki/Perpendicular' target='_blank'><b>perpendicular</b></a> to the <strong>white</strong> line</span>",!0);registerDriverAnimation(stage.get("#driverBox")[0],{arrow:[[x,u,A]]})};var startFrame=function(a){var b=new Kinetic.Layer;activeLayer=b;a=new Kinetic.Text({x:0,y:20,text:"Hello "+a+",\nYou'll be taken through a series of tests.You can hover your mouse over here to get more information about the corresponding task.\nTo start click here.\nGood luck & enjoy ...",fontSize:20,fontFamily:"chalkdusterregular",textFill:"#fff",width:500,padding:20,align:"center",lineHeight:2});var d=new Kinetic.Ellipse({x:360,y:290,radius:{x:40,y:20},fill:"transparent",stroke:"green",strokeWidth:4}),c=new Kinetic.Ellipse({x:324,y:170,radius:{x:40,y:20},fill:"transparent",stroke:"green",strokeWidth:4}),e=new Kinetic.Shape({drawFunc:function(a){a.beginPath();a.moveTo(400,290);a.quadraticCurveTo(460,320,460,380);a.lineTo(450,360);a.moveTo(460,384);a.lineTo(468,358);a.moveTo(284,170);a.quadraticCurveTo(100,100,250,20);a.lineTo(235,40);a.moveTo(254,16);a.lineTo(224,23);this.fillStroke(a)},stroke:"green",strokeWidth:4});b.add(e);b.add(a);b.add(d);b.add(c);stage.add(b)};var endFrame=function(a,b){var d=new Kinetic.Layer;activeLayer=d;var c=jQuery(".counter .part0 .digit").html(),e=10*parseInt(jQuery(".counter .part2 .digit").html())+parseInt(jQuery(".counter .part2 .digit").next().html())+parseInt(jQuery(".counter .part4 .digit").html())/10,f="unit"+(1<b?"s":""),g="minute"+(1<parseInt(c)?"s":""),f=new Kinetic.Text({x:0,y:60,text:"That's it\n\nYou ended up with an average accuracy of               "+f+" in\n   "+g+"        "+("second"+(1<e?"s":""))+".",fontSize:20,fontFamily:"chalkdusterregular",textFill:"#fff",width:500,padding:30,align:"center",lineHeight:2});a=new Kinetic.Text({x:0,y:100,text:a+" !",fontSize:20,fontFamily:"chalkdusterregular",textFill:"#0f0",width:500,padding:30,align:"center",lineHeight:2});b=new Kinetic.Text({x:50,y:222,text:(b+5E-4).toFixed(3),fontSize:20,fontFamily:"chalkdusterregular",textFill:"#f00",width:500,padding:30,align:"left"});c=new Kinetic.Text({x:4,y:258,text:c,fontSize:22,fontFamily:"chalkdusterregular",textFill:"#ff0",width:500,padding:30,align:"left"});e=new Kinetic.Text({x:190,y:258,text:e,fontSize:22,fontFamily:"chalkdusterregular",textFill:"#ff0",width:500,padding:30,align:"left"});d.add(f);d.add(a);d.add(b);d.add(c);d.add(e);stage.add(d)};var frames=[bisectFrame,midPointFrame,circleFrame,rectFrame,convergeFrame,diaFrame,rightFrame,triFrame],frameIndex=0,nRound=2,graph=null;function updateGraphData(a){var b=!1,d=parseFloat((a-0.01).toFixed(1));for(a=0;a<graph_data.length;a++){if(graph_data[a][0]==d){graph_data[a][1]+=1;b=!0;break}if(graph_data[a][0]>d)break}b||graph_data.splice(a,0,[d,1])}
function nextFrame(){activeLayer&&activeLayer.hide();stage.clear();graph&&(jQuery("#plot-holder").css("display","none"),jQuery("#plot-selector").css("display","none"),graph.getChart().clearChart(),jQuery("#accuracy-container").show(),jQuery('#share-app ul').animate({width:'toggle'},1000),graph="",jQuery(".counter").counter("reset"),jQuery("#avg-error").html(""),jQuery("#score-board li").html("-"),count=globalError=0,registerGameInit(name,gender,user_id,address));if(nRound)if(0>nRound){jQuery("#plot-holder").css("display","block");jQuery("#plot-selector").css("display","block");graph=showGraph(globalError/(2*frames.length));jQuery('#share-app ul').animate({width:'toggle'},1000);jQuery(".clickable").html("Try Again");jQuery(".clickable").addClass("rotate");jQuery(".tiptip").html("Error Distribution Graph");jQuery(".tiptip").tipTip({defaultPosition:"bottom",content:"The horizontal axis represents the <i>Error</i> whereas the vertical one is showing the <i><b>%</b> of people</i>.<br>Hover over the plot to see individual details."});var a=290-jQuery(".tiptip").width()/2;jQuery(".unselectable").css({left:a});jQuery("#accuracy-container").hide();nRound=1;frameIndex=0}else jQuery(".clickable").hide("explode",{pieces:8},function(){jQuery(".clickable").html("Next");jQuery(".clickable").hasClass("rotate")&&jQuery(".clickable").removeClass("rotate")},1400),frames[frameIndex](2*frameIndex+2-nRound),frameIndex+=1,(frameIndex%=frames.length)||(nRound-=1);else endFrame(userName,globalError/(2*frames.length)),a=60*parseInt(jQuery(".counter .part0 .digit").html())+10*parseInt(jQuery(".counter .part2 .digit").html())+parseInt(jQuery(".counter .part2 .digit").next().html())+parseInt(jQuery(".counter .part4 .digit").html())/10,postData(name,gender,user_id,address,jQuery("#avg-error").html(),a),updateGraphData(globalError/(2*frames.length)),jQuery(".clickable").html("Show Graph"),jQuery("#accuracy .one").odoTicker({number:0}),jQuery("#accuracy .two").odoTicker({number:0}),jQuery(".tiptip").html(""),nRound-=1};